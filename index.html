<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Hexo">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Hexo">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title>Hexo</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Hexo</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-主页">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            主页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-所有文章">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            所有文章
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/12/11/用Python给杰伦做张萌萌哒头像/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="不正">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/11/用Python给杰伦做张萌萌哒头像/" itemprop="url">用Python给杰伦做张萌萌哒头像</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-12-11T00:55:48+08:00">
                2017-12-11
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="https://github.com/buzheng1949/Athena" target="_blank" rel="noopener">给杰伦做张头像源码</a></p>
<p>如果链接无法点击，请直接点击：<a href="https://github.com/buzheng1949/Athena" target="_blank" rel="noopener">https://github.com/buzheng1949/Athena</a></p>
<p><a href="https://github.com/buzheng1949/Athena/tree/master/FreeServer" target="_blank" rel="noopener">自动化脚本登录服务器</a></p>
<ul>
<li><p>需求分析</p>
<ul>
<li>需要的数据从哪里来？<ul>
<li>酷狗</li>
<li>网易云</li>
<li>QQ音乐</li>
</ul>
</li>
</ul>
<p>后续可能会进行评论的抓取，于是选择了网易云</p>
<ul>
<li>如何抓取<ul>
<li>可以先抓专辑数据、再从专辑数据抓歌曲数据、再从歌曲数据抓歌曲的歌词</li>
</ul>
</li>
<li>如何生成热词分析<ul>
<li>我们采用Wordcloud词云进行歌词切词以及分析</li>
</ul>
</li>
<li>定下我们需要的第三方库<ul>
<li>网络请求我们需要用requests，requests可能会有中文乱码的坑，如果遇到问题可以使用urlib</li>
<li>词频切词以及热词图生成需要用matplotlib、wordcloud、jieba、PIL</li>
</ul>
</li>
</ul>
</li>
<li><p>动手做起来</p>
<ul>
<li>首先我们需要看一下怎么获取专辑的歌曲呢？<br><img src="https://user-gold-cdn.xitu.io/2017/12/1/1601139faac32104?w=2560&amp;h=1312&amp;f=png&amp;s=852127" alt="获取所有专辑接口"><br>从上图我们可以看出，网易云音乐的专辑页面的请求地址是<strong><a href="http://music.163.com/artist/album?id=6452&amp;limit=100" target="_blank" rel="noopener">http://music.163.com/artist/album?id=6452&amp;limit=100</a></strong>id指的是某个艺人的代号？limit是获取的专辑最大数量，offset是从第几张开始获取。</li>
</ul>
<p>既然可以获取到专辑，我们可以审查网页元素，看看我们需要的专辑链接可以在哪里获得？<br><img src="https://user-gold-cdn.xitu.io/2017/12/1/1601139fa154633c?w=2560&amp;h=1218&amp;f=png&amp;s=1130041" alt="单张专辑链接获取"><br>从图我们可以看到，红框里面就是我们需要的href每个专辑的链接，需要注意的是，这里是短链接，我们需要在链接前面加入<strong><a href="http://music.163.com/" target="_blank" rel="noopener">http://music.163.com/</a></strong>拼接成完整的链接。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># 获取所有专辑的链接</span><br><span class="line">  def get_all_ablum_links(self,url):</span><br><span class="line">      ablum_message = self.downloader.download(url)</span><br><span class="line">      if ablum_message is None:</span><br><span class="line">          print (&quot;get the ablum&apos;s detail image&quot;)</span><br><span class="line">          return </span><br><span class="line">      else:</span><br><span class="line">          soup = BeautifulSoup(ablum_message,&apos;html.parser&apos;,from_encoding=&apos;utf-8&apos;)</span><br><span class="line">          ablum_nodes = soup.find_all(&apos;div&apos;,class_ =&apos;u-cover u-cover-alb3&apos;)</span><br><span class="line">          for node in ablum_nodes:</span><br><span class="line">              ablum_link_short = node.find(&apos;a&apos;).get(&apos;href&apos;).encode(&apos;utf-8&apos;)</span><br><span class="line">              ablum_link = &apos;http://music.163.com&apos;+ablum_link_short</span><br><span class="line">              self.urls.add(ablum_link)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>从上面我们可以获取所有专辑的具体链接，现在我们来看下单张专辑的歌曲链接，如下图所示：<br><img src="https://user-gold-cdn.xitu.io/2017/12/1/1601139fa3e9be9a?w=2534&amp;h=1356&amp;f=png&amp;s=818942" alt=""><br>从图中我们可以看到，href属性里面带着歌曲的信息，这是我们要的歌曲ID.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 获取所有的歌曲的ID以及歌曲名存放在字典里面</span><br><span class="line">  def get_all_songs(self,ablum_links):</span><br><span class="line">      while len(self.urls) &gt; 0:</span><br><span class="line">          ablum_url = self.urls.pop()</span><br><span class="line">          ablum_songs_detail = self.downloader.download(ablum_url)</span><br><span class="line">          soup = BeautifulSoup(ablum_songs_detail,&apos;html.parser&apos;,from_encoding=&apos;utf-8&apos;)</span><br><span class="line">          nodes = soup.findAll(name = &apos;a&apos;, attrs = &#123;&apos;href&apos;:re.compile(r&apos;/song.id=\d&#123;1,10&#125;&apos;)&#125;)</span><br><span class="line">          for node in nodes:</span><br><span class="line">              song_short_link = node.get(&apos;href&apos;)</span><br><span class="line">              song_id = re.findall(&quot;\d+&quot;,song_short_link)[0]</span><br><span class="line">              self.songs_dict[node.get_text()] = song_id</span><br><span class="line">      return self.songs_dict</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>我们可以拿到歌曲的ID，我们也可以获取歌曲的具体歌词了,接口如下图所示：<strong><a href="http://music.163.com/api/song/lyric?lv=1&amp;kv=1&amp;tv=-1&amp;id=186039" target="_blank" rel="noopener">http://music.163.com/api/song/lyric?lv=1&amp;kv=1&amp;tv=-1&amp;id=186039</a></strong>其中ID就是上一步我们获取的歌曲ID<br><img src="https://user-gold-cdn.xitu.io/2017/12/1/1601139fa12806e3?w=2560&amp;h=1272&amp;f=png&amp;s=709497" alt="歌曲歌词"><br>可以看到歌词了，再来一个正则匹配，我们就可以获取我们要的歌词信息了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># 通过歌曲ID获取歌曲的歌词</span><br><span class="line">   def get_lyric_by_music_id(self,song_id):</span><br><span class="line">       lrc_url = &apos;http://music.163.com/api/song/lyric?&apos; + &apos;id=&apos; + str(song_id) + &apos;&amp;lv=1&amp;kv=1&amp;tv=-1&apos;</span><br><span class="line">       lyric = requests.get(lrc_url) </span><br><span class="line">       j = json.loads(lyric.text)</span><br><span class="line">       try:</span><br><span class="line">           lrc = j[&apos;lrc&apos;][&apos;lyric&apos;]</span><br><span class="line">           pat = re.compile(r&apos;\[.*\]&apos;)</span><br><span class="line">           lrc = re.sub(pat,&quot;&quot;,lrc)</span><br><span class="line">           lrc = lrc.strip()</span><br><span class="line">           return lrc</span><br><span class="line">       except:</span><br><span class="line">           print (&apos;cannot get the lrc from Net,it is has no matter&apos;)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>获取完歌词，下一步是对歌词进行切词，整理出高频词汇，这个步骤我们采用jieba进行分析,使用方式非常简单，就是调用jieba的cut方法即可。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># 分词后进行数据采集并生成热词云图</span><br><span class="line">   def get_hot_words (self,songs_dict):</span><br><span class="line">           for key in songs_dict.keys():</span><br><span class="line">               try:</span><br><span class="line">                   song_id = self.songs_dict.get(key)</span><br><span class="line">                   song_detail = self.get_lyric_by_music_id(song_id).encode(&apos;utf-8&apos;)</span><br><span class="line">                   self.lyrics += song_detail</span><br><span class="line">               except:</span><br><span class="line">                   # 有些歌曲是木有歌词的我们可以忽略</span><br><span class="line">                   print (&apos;the song has no lrc ,the song id is %s&apos;%(song_id))</span><br><span class="line">           words=list(jieba.cut(self.lyrics)) # 把所有歌词进行分词</span><br><span class="line">           key_words = []</span><br><span class="line">           for word in words:</span><br><span class="line">               try:</span><br><span class="line">                   if len(word)&gt;1:</span><br><span class="line">                       key_words.append(word)</span><br><span class="line">               except :</span><br><span class="line">                   pass</span><br><span class="line">           hot_key_words=r&apos; &apos;.join(key_words)</span><br><span class="line">           return hot_key_words</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>使用jieba进行高频词汇分析后，我们可以使用wordcloud加PIL进行图片生成。需要注意的是，我们是需要指定字体的，于是我下载了mysh使用，没有指定字体会一堆乱码的现象。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># 生成热词云图</span><br><span class="line">   def assemble_hot_image(self,hot_key_words):</span><br><span class="line">           path=&apos;font/msyh.ttf&apos;</span><br><span class="line">           path=unicode(path, &apos;utf8&apos;).encode(&apos;utf-8&apos;)</span><br><span class="line">           alice_mask = np.array(PIL.Image.open(&apos;images/jay.jpeg&apos;))</span><br><span class="line">           wordcloud = WordCloud(font_path=path, </span><br><span class="line">                               background_color=&quot;white&quot;,   </span><br><span class="line">                                width=1800,</span><br><span class="line">                                height=800,</span><br><span class="line">                                mask=alice_mask,</span><br><span class="line">                                max_words=3000,</span><br><span class="line">                                max_font_size=12,</span><br><span class="line">                                random_state=32) </span><br><span class="line">           wordcloud = wordcloud.generate(hot_key_words)</span><br><span class="line">           wordcloud.to_file(&apos;images/image.jpg&apos;)</span><br><span class="line">           plt.imshow(wordcloud)</span><br><span class="line">           plt.axis(&quot;off&quot;)</span><br><span class="line">           plt.show()</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>看看效果吧，嘿嘿，我使用了一张杰伦的经典头像作为背景图，生成的云图如下：<br><img src="https://user-gold-cdn.xitu.io/2017/12/1/1601139faabf8b28?w=301&amp;h=458&amp;f=jpeg&amp;s=5909" alt="Jay头像"><br><img src="https://user-gold-cdn.xitu.io/2017/12/1/1601139fab358926?w=301&amp;h=458&amp;f=jpeg&amp;s=25001" alt="云图"><br>至此我们的工作也就完工了。</p>
</li>
<li><p>依旧不出意外的源码分享</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"># coding=utf-8</span><br><span class="line">import requests</span><br><span class="line">from bs4 import BeautifulSoup</span><br><span class="line">import sys</span><br><span class="line">import chardet</span><br><span class="line">import re</span><br><span class="line">import json</span><br><span class="line">from wordcloud import WordCloud</span><br><span class="line">import jieba</span><br><span class="line">import PIL</span><br><span class="line">import matplotlib.pyplot as plt</span><br><span class="line">import jieba.analyse</span><br><span class="line">import numpy as np</span><br><span class="line">import os</span><br><span class="line"></span><br><span class="line"># 下载网页工具类</span><br><span class="line">class HTMLHelper:</span><br><span class="line">    def __init__(self):</span><br><span class="line">        pass</span><br><span class="line">    def download(self,url):</span><br><span class="line">        s = requests.session()</span><br><span class="line">        headers = &#123;</span><br><span class="line">        &apos;Referer&apos;:&apos;http://music.163.com/&apos;,</span><br><span class="line">        &apos;Host&apos;:&apos;music.163.com&apos;,</span><br><span class="line">        &apos;Accept&apos;:&apos;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8&apos;,</span><br><span class="line">        &apos;User-Agent&apos;:&apos;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_11_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/62.0.3202.94 Safari/537.36&apos;</span><br><span class="line">        &#125;</span><br><span class="line">        ret = s.get(url,headers = headers)</span><br><span class="line">        if ret.status_code == 200:</span><br><span class="line">            return ret.text</span><br><span class="line">        else:</span><br><span class="line">            return None</span><br><span class="line"></span><br><span class="line"># 爬虫工具类</span><br><span class="line">class Spider:</span><br><span class="line">    def __init__(self):</span><br><span class="line">        self.urls = set()</span><br><span class="line">        self.downloader = HTMLHelper()</span><br><span class="line">        self.songs_dict = &#123;&#125;</span><br><span class="line">        self.lyrics= &apos;&apos;</span><br><span class="line"></span><br><span class="line">    # 生成热词图</span><br><span class="line">    def image_for_jaychou(self,url):</span><br><span class="line">        ablums = self.get_all_ablum_links(url)</span><br><span class="line">        songs_dict = self.get_all_songs(ablums)</span><br><span class="line">        hot_key_words = self.get_hot_words(songs_dict)</span><br><span class="line">        self.assemble_hot_image(hot_key_words)</span><br><span class="line"></span><br><span class="line">    # 获取所有专辑的链接</span><br><span class="line">    def get_all_ablum_links(self,url):</span><br><span class="line">        ablum_message = self.downloader.download(url)</span><br><span class="line">        if ablum_message is None:</span><br><span class="line">            print (&quot;get the ablum&apos;s detail image&quot;)</span><br><span class="line">            return </span><br><span class="line">        else:</span><br><span class="line">            soup = BeautifulSoup(ablum_message,&apos;html.parser&apos;,from_encoding=&apos;utf-8&apos;)</span><br><span class="line">            ablum_nodes = soup.find_all(&apos;div&apos;,class_ =&apos;u-cover u-cover-alb3&apos;)</span><br><span class="line">            for node in ablum_nodes:</span><br><span class="line">                ablum_link_short = node.find(&apos;a&apos;).get(&apos;href&apos;).encode(&apos;utf-8&apos;)</span><br><span class="line">                ablum_link = &apos;http://music.163.com&apos;+ablum_link_short</span><br><span class="line">                self.urls.add(ablum_link)</span><br><span class="line">    </span><br><span class="line">    # 获取所有的歌曲的ID以及歌曲名存放在字典里面</span><br><span class="line">    def get_all_songs(self,ablum_links):</span><br><span class="line">        while len(self.urls) &gt; 0:</span><br><span class="line">            ablum_url = self.urls.pop()</span><br><span class="line">            ablum_songs_detail = self.downloader.download(ablum_url)</span><br><span class="line">            soup = BeautifulSoup(ablum_songs_detail,&apos;html.parser&apos;,from_encoding=&apos;utf-8&apos;)</span><br><span class="line">            nodes = soup.findAll(name = &apos;a&apos;, attrs = &#123;&apos;href&apos;:re.compile(r&apos;/song.id=\d&#123;1,10&#125;&apos;)&#125;)</span><br><span class="line">            for node in nodes:</span><br><span class="line">                song_short_link = node.get(&apos;href&apos;)</span><br><span class="line">                song_id = re.findall(&quot;\d+&quot;,song_short_link)[0]</span><br><span class="line">                self.songs_dict[node.get_text()] = song_id</span><br><span class="line">        return self.songs_dict</span><br><span class="line"></span><br><span class="line">    # 通过歌曲ID获取歌曲的歌词</span><br><span class="line">    def get_lyric_by_music_id(self,song_id):</span><br><span class="line">        lrc_url = &apos;http://music.163.com/api/song/lyric?&apos; + &apos;id=&apos; + str(song_id) + &apos;&amp;lv=1&amp;kv=1&amp;tv=-1&apos;</span><br><span class="line">        lyric = requests.get(lrc_url) </span><br><span class="line">        j = json.loads(lyric.text)</span><br><span class="line">        try:</span><br><span class="line">            lrc = j[&apos;lrc&apos;][&apos;lyric&apos;]</span><br><span class="line">            pat = re.compile(r&apos;\[.*\]&apos;)</span><br><span class="line">            lrc = re.sub(pat,&quot;&quot;,lrc)</span><br><span class="line">            lrc = lrc.strip()</span><br><span class="line">            return lrc</span><br><span class="line">        except:</span><br><span class="line">            print (&apos;cannot get the lrc from Net,it is has no matter&apos;)</span><br><span class="line"></span><br><span class="line">    # 分词后进行数据采集并生成热词云图</span><br><span class="line">    def get_hot_words (self,songs_dict):</span><br><span class="line">            for key in songs_dict.keys():</span><br><span class="line">                try:</span><br><span class="line">                    song_id = self.songs_dict.get(key)</span><br><span class="line">                    song_detail = self.get_lyric_by_music_id(song_id).encode(&apos;utf-8&apos;)</span><br><span class="line">                    self.lyrics += song_detail</span><br><span class="line">                except:</span><br><span class="line">                    # 有些歌曲是木有歌词的我们可以忽略</span><br><span class="line">                    print (&apos;the song has no lrc ,the song id is %s&apos;%(song_id))</span><br><span class="line">            words=list(jieba.cut(self.lyrics)) # 把所有歌词进行分词</span><br><span class="line">            key_words = []</span><br><span class="line">            for word in words:</span><br><span class="line">                try:</span><br><span class="line">                    if len(word)&gt;1:</span><br><span class="line">                        key_words.append(word)</span><br><span class="line">                except :</span><br><span class="line">                    pass</span><br><span class="line">            hot_key_words=r&apos; &apos;.join(key_words)</span><br><span class="line">            return hot_key_words</span><br><span class="line"></span><br><span class="line">    # 生成热词云图</span><br><span class="line">    def assemble_hot_image(self,hot_key_words):</span><br><span class="line">            path=&apos;font/msyh.ttf&apos;</span><br><span class="line">            path=unicode(path, &apos;utf8&apos;).encode(&apos;utf-8&apos;)</span><br><span class="line">            alice_mask = np.array(PIL.Image.open(&apos;images/jay.jpeg&apos;))</span><br><span class="line">            wordcloud = WordCloud(font_path=path, </span><br><span class="line">                                background_color=&quot;white&quot;,   </span><br><span class="line">                                 width=1800,</span><br><span class="line">                                 height=800,</span><br><span class="line">                                 mask=alice_mask,</span><br><span class="line">                                 max_words=3000,</span><br><span class="line">                                 max_font_size=12,</span><br><span class="line">                                 random_state=32) </span><br><span class="line">            wordcloud = wordcloud.generate(hot_key_words)</span><br><span class="line">            wordcloud.to_file(&apos;images/image.jpg&apos;)</span><br><span class="line">            plt.imshow(wordcloud)</span><br><span class="line">            plt.axis(&quot;off&quot;)</span><br><span class="line">            plt.show()</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">def main():</span><br><span class="line">    spider = Spider()</span><br><span class="line">    url = &quot;http://music.163.com/artist/album?id=6452&amp;limit=100&quot;</span><br><span class="line">    spider.image_for_jaychou(url)</span><br><span class="line"></span><br><span class="line">if __name__ == &apos;__main__&apos;:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/12/10/Java-注解/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="不正">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/10/Java-注解/" itemprop="url">关于Java中的注解</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-12-10T23:38:14+08:00">
                2017-12-10
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="一、注解是什么"><a href="#一、注解是什么" class="headerlink" title="一、注解是什么"></a>一、注解是什么</h4><ul>
<li><p>概念</p>
<p>注解是一种元数据，一种用于描述数据的数据。如下面的代码所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">class Self &#123;</span><br><span class="line">      @Override</span><br><span class="line">      public String toString() &#123;</span><br><span class="line">          return super.toString();</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>Self类重写了toString()方法，该方法上有Override注解表明该方法是复写了父类的方法，如果我们写错了方法名，编译器会报错，这就是注解能帮我们做的事情。<strong>从上面的例子我们可以看到注解就是用于描述数据的一种方式</strong></p>
</li>
<li><p>注解分类</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Target(ElementType.METHOD)</span><br><span class="line">@Retention(RetentionPolicy.SOURCE)</span><br><span class="line">public @interface Override &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从上面的Override注解我们可以看到上面有一个@Retention的元注解，@Retention元注解表示该注解的保留期限。我们看下源代码如何定义@Retention。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@Documented</span><br><span class="line">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">@Target(ElementType.ANNOTATION_TYPE)</span><br><span class="line">public @interface Retention &#123;</span><br><span class="line">    /**</span><br><span class="line">     * Returns the retention policy.</span><br><span class="line">     * @return the retention policy</span><br><span class="line">     */</span><br><span class="line">    RetentionPolicy value();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到注解的有效期限是根据RetentionPolicy这个枚举去确定的，我们可以看下RetentionPolicy是如何定义的。</p>
</li>
</ul>
<pre><code><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">public enum RetentionPolicy &#123;</span><br><span class="line">   /**</span><br><span class="line">    * Annotations are to be discarded by the compiler.</span><br><span class="line">    */</span><br><span class="line">   SOURCE,</span><br><span class="line"></span><br><span class="line">   /**</span><br><span class="line">    * Annotations are to be recorded in the class file by the compiler</span><br><span class="line">    * but need not be retained by the VM at run time.  This is the default</span><br><span class="line">    * behavior.</span><br><span class="line">    */</span><br><span class="line">   CLASS,</span><br><span class="line"></span><br><span class="line">   /**</span><br><span class="line">    * Annotations are to be recorded in the class file by the compiler and</span><br><span class="line">    * retained by the VM at run time, so they may be read reflectively.</span><br><span class="line">    *</span><br><span class="line">    * @see java.lang.reflect.AnnotatedElement</span><br><span class="line">    */</span><br><span class="line">   RUNTIME</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</code></pre><p>我们可以看到共3个有效时间，第一个是Source源码时保存、第二个CLASS表示会在class文件保存但是不会在VM或者运行期保存、第三个是RUNTIME表示从编译成class文件、VM或者RUNTIME时间都会进行保存。于是可以简单的将注解分为以下几类：<br>    1、源码注解<br>    2、编译注解<br>    3、运行注解</p>
<h4 id="二、注解的元注解解析"><a href="#二、注解的元注解解析" class="headerlink" title="二、注解的元注解解析"></a>二、注解的元注解解析</h4><p>我们注意到注解经常出现的四个元注解,如下代码所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Created by buzheng on 17/12/5.</span><br><span class="line"> */</span><br><span class="line">@Inherited</span><br><span class="line">@Target(ElementType.METHOD)</span><br><span class="line">@Documented</span><br><span class="line">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">public @interface PersonMessage &#123;</span><br><span class="line"></span><br><span class="line">    int age() default 18;</span><br><span class="line"></span><br><span class="line">    String name() default &quot;buzheng&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>Inherited 注解可否被继承</li>
<li><p>Target 表示注解可以使用的目标位置，比较常见的是FIELD作用于字段，TYPE作用于类、接口、枚举等等，METHOD作用于方法等等，具体的如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"> public enum ElementType &#123;</span><br><span class="line">    /** Class, interface (including annotation type), or enum declaration */</span><br><span class="line">    TYPE,</span><br><span class="line"></span><br><span class="line">    /** Field declaration (includes enum constants) */</span><br><span class="line">    FIELD,</span><br><span class="line"></span><br><span class="line">    /** Method declaration */</span><br><span class="line">    METHOD,</span><br><span class="line"></span><br><span class="line">    /** Formal parameter declaration */</span><br><span class="line">    PARAMETER,</span><br><span class="line"></span><br><span class="line">    /** Constructor declaration */</span><br><span class="line">    CONSTRUCTOR,</span><br><span class="line"></span><br><span class="line">    /** Local variable declaration */</span><br><span class="line">    LOCAL_VARIABLE,</span><br><span class="line"></span><br><span class="line">    /** Annotation type declaration */</span><br><span class="line">    ANNOTATION_TYPE,</span><br><span class="line"></span><br><span class="line">    /** Package declaration */</span><br><span class="line">    PACKAGE,</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Type parameter declaration</span><br><span class="line">     *</span><br><span class="line">     * @since 1.8</span><br><span class="line">     */</span><br><span class="line">    TYPE_PARAMETER,</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Use of a type</span><br><span class="line">     *</span><br><span class="line">     * @since 1.8</span><br><span class="line">     */</span><br><span class="line">    TYPE_USE</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Documented 注解可以生成文档</p>
</li>
<li>Retention 表示注解的有效持续时间，前面已经讲到了，可以分为以下三种<ul>
<li>SOURCE 源码保留注解</li>
<li>CLASS 编译生成的class文件保留注解</li>
<li>RUNTIME 运行期保留注解</li>
</ul>
</li>
</ul>
<h4 id="三、如何写一个注解"><a href="#三、如何写一个注解" class="headerlink" title="三、如何写一个注解"></a>三、如何写一个注解</h4><ul>
<li><p>注解用@interface关键字标识是一个注解</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public @interface PersonMessage &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>给注解加入元注解，一般加入上面我们说的四个元注解</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@Inherited</span><br><span class="line">@Target(ElementType.METHOD)</span><br><span class="line">@Documented</span><br><span class="line">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">public @interface PersonMessage &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>给注解定义字段</p>
<ul>
<li>注解支持多种字段类型，除了常用的基本数据类型外，还支持枚举、注解等等。</li>
<li>注解字段默认值可加可不加</li>
<li><p>如果注解只有一个字段，字段名必须为value</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@Inherited</span><br><span class="line">@Target(ElementType.METHOD)</span><br><span class="line">@Documented</span><br><span class="line">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">public @interface PersonMessage &#123;</span><br><span class="line"></span><br><span class="line">    int age() default 18;</span><br><span class="line"></span><br><span class="line">    String name() default &quot;buzheng&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<h4 id="四、如何使用并解析注解"><a href="#四、如何使用并解析注解" class="headerlink" title="四、如何使用并解析注解"></a>四、如何使用并解析注解</h4><p>假如我们定义了两个注解，一个是作用在类上面的，一个是作用在方法上面的，在运行的时候，我们需要取解析他们，代码如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">package com.buzheng.annotation;</span><br><span class="line"></span><br><span class="line">import java.lang.annotation.Annotation;</span><br><span class="line">import java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Created by buzheng on 17/12/5.</span><br><span class="line"> */</span><br><span class="line">@TestAnnotation(name = &quot;AnotationTest in class&quot;)</span><br><span class="line">public class AnnotationTest &#123;</span><br><span class="line"></span><br><span class="line">    @PersonMessage(name = &quot;yupeibiao&quot;, age = 23)</span><br><span class="line">    private String getPersonMessage() &#123;</span><br><span class="line">        return &quot;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        AnnotationTest anotationTest = new AnnotationTest();</span><br><span class="line">        Class c = anotationTest.getClass();</span><br><span class="line">        //判断是否是这个注解</span><br><span class="line">        boolean isAnotation = c.isAnnotationPresent(TestAnnotation.class);</span><br><span class="line">        if (isAnotation) &#123;</span><br><span class="line">            //将类上的注解拿出来</span><br><span class="line">            TestAnnotation testAnotation = (TestAnnotation) c.getAnnotation(TestAnnotation.class);</span><br><span class="line">            //输出注解信息</span><br><span class="line">            System.out.println(testAnotation.name());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Method[] methods = c.getDeclaredMethods();</span><br><span class="line">        for (Method method : methods) &#123;</span><br><span class="line">            PersonMessage message = method.getAnnotation(PersonMessage.class);</span><br><span class="line">            if (message == null) &#123;</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(message.age());</span><br><span class="line">            System.out.println(message.name());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        for (Method method : methods) &#123;</span><br><span class="line">            Annotation[] annotations = method.getAnnotations();</span><br><span class="line">            for (Annotation annotation : annotations) &#123;</span><br><span class="line">                if (annotation instanceof PersonMessage) &#123;</span><br><span class="line">                    PersonMessage message = (PersonMessage) annotation;</span><br><span class="line">                    System.out.println(message.age() + &quot;  &quot;);</span><br><span class="line">                    System.out.println(message.name());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以看到，无论是拿类上面的注解信息或者是方法上面的注解信息，我们都是通过反射的方法进行获取的，流程大概如下：</p>
<ul>
<li>通过反射获取需要解析的类</li>
<li>如果需要获取类上面的注解，先判断类上面是否有注解c.isAnnotationPresent(YourAnnotation.class);</li>
<li>获取类上的注解信息c.getAnnotation(YourAnnotation.class);</li>
<li>如果需要获取方法或者字段的注解信息，大致流程跟上述获取类的注解信息的方法一致，只是调用的方法不同。</li>
</ul>
<p>比如上面的流程我们可以运行获取到运行结果：<br><img src="https://user-gold-cdn.xitu.io/2017/12/5/16024ef86c280bb0?w=1240&amp;h=442&amp;f=png&amp;s=69384" alt="运行结果"></p>
<h4 id="五、简单的注解使用例子"><a href="#五、简单的注解使用例子" class="headerlink" title="五、简单的注解使用例子"></a>五、简单的注解使用例子</h4><ul>
<li><p>假如我们有这样的一个需求，我们有一个Query，需要跟SQL进行字段的一一对应（不考虑MyBatis），然后我们构建出一条SQL可以用于执行。那我们可以在Query类用注解指定类名，字段名，然后到时候通过反射获取每个字段的值，这样我们就能把整条SQL拼接起来</p>
<p>首先我们在Query上需要使用的两个注解：</p>
<ul>
<li>第一个是定义在类上面，指定类对应表名的注解</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">  /**</span><br><span class="line"> * Created by buzheng on 17/12/5.</span><br><span class="line"> * 该注解用于类上，标明类对应的表名是什么</span><br><span class="line"> */</span><br><span class="line">@Inherited</span><br><span class="line">@Documented</span><br><span class="line">@Target(ElementType.TYPE)</span><br><span class="line">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">public @interface Table &#123;</span><br><span class="line">    String value();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>第二个定义在类的字段上面，指定字段跟表的字段对应的注解</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> /**</span><br><span class="line"> * Created by buzheng on 17/12/5.</span><br><span class="line"> * 该注解用于标明类字段跟表字段向的一一对应关系</span><br><span class="line"> */</span><br><span class="line">@Inherited</span><br><span class="line">@Target(ElementType.FIELD)</span><br><span class="line">@Documented</span><br><span class="line">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">public @interface Row &#123;</span><br><span class="line">    String value();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>给Query定义注解，绑定跟查询的表的一一对应关系</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">    /**</span><br><span class="line">	 * Created by buzheng on 17/12/5.</span><br><span class="line">	 */</span><br><span class="line">	@Table(&quot;student&quot;)</span><br><span class="line">	public class Query &#123;</span><br><span class="line"></span><br><span class="line">    @Row(&quot;student_name&quot;)</span><br><span class="line">    private String name;</span><br><span class="line"></span><br><span class="line">    @Row(&quot;student_age&quot;)</span><br><span class="line">    private int age;</span><br><span class="line"></span><br><span class="line">    @Row(&quot;student_grade&quot;)</span><br><span class="line">    private int grade;</span><br><span class="line"></span><br><span class="line">    @Row(&quot;student_number&quot;)</span><br><span class="line">    private int number;</span><br><span class="line"></span><br><span class="line">    @Row((&quot;id&quot;))</span><br><span class="line">    private int id;</span><br><span class="line"></span><br><span class="line">    public String getName() &#123;</span><br><span class="line">        return name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setName(String name) &#123;</span><br><span class="line">        this.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public int getAge() &#123;</span><br><span class="line">        return age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setAge(int age) &#123;</span><br><span class="line">        this.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public int getGrade() &#123;</span><br><span class="line">        return grade;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setGrade(int grade) &#123;</span><br><span class="line">        this.grade = grade;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public int getNumber() &#123;</span><br><span class="line">        return number;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setNumber(int number) &#123;</span><br><span class="line">        this.number = number;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public int getId() &#123;</span><br><span class="line">        return id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setId(int id) &#123;</span><br><span class="line">        this.id = id;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>解析注解、获取字段值并拼装SQL</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">	 /**</span><br><span class="line">	 * Created by buzheng on 17/12/5.</span><br><span class="line">	 */</span><br><span class="line">	public class Test &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        Query query = new Query();</span><br><span class="line">        query.setAge(1);</span><br><span class="line">        query.setId(1);</span><br><span class="line">        query.setName(&quot;buzheng&quot;);</span><br><span class="line">        System.out.println(getQueryFromAnnotation(query));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 传进来查询的Query类 解析并拼装sql</span><br><span class="line">     *</span><br><span class="line">     * @param object</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    public static String getQueryFromAnnotation(Object object) &#123;</span><br><span class="line">        Class clazz = object.getClass();</span><br><span class="line">        boolean flag = clazz.isAnnotationPresent(Table.class);</span><br><span class="line">        StringBuilder stringBuilder = new StringBuilder(&quot;select * from &quot;);</span><br><span class="line">        if (!flag) &#123;</span><br><span class="line">            return stringBuilder.toString();</span><br><span class="line">        &#125;</span><br><span class="line">        Table table = (Table) clazz.getAnnotation(Table.class);</span><br><span class="line">        stringBuilder.append(table.value());</span><br><span class="line">        stringBuilder.append(&quot; where 1=1 &quot;);</span><br><span class="line">        java.lang.reflect.Field[] fileds = clazz.getDeclaredFields();</span><br><span class="line">        for (Field field : fileds) &#123;</span><br><span class="line">            boolean isFiledAnnotation = field.isAnnotationPresent(Row.class);</span><br><span class="line">            if (isFiledAnnotation) &#123;</span><br><span class="line">                stringBuilder.append(&quot; and &quot;);</span><br><span class="line">                Row row = (Row) field.getAnnotation(Row.class);</span><br><span class="line">                String fieldName = field.getName();</span><br><span class="line">                String methodName = &quot;get&quot; + fieldName.substring(0, 1).toUpperCase() + fieldName.substring(1, fieldName.length());</span><br><span class="line">                try &#123;</span><br><span class="line">                    Method method = clazz.getMethod(methodName);</span><br><span class="line">                    Object value = method.invoke(object);</span><br><span class="line">                    if (value == null || (value instanceof Integer &amp;&amp; (Integer) value == 0)) &#123;</span><br><span class="line">                        continue;</span><br><span class="line">                    &#125;</span><br><span class="line">                    stringBuilder.append(row.value() + &quot; = &quot; + value);</span><br><span class="line">                &#125; catch (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return stringBuilder.toString();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>  运行上述代码可以看到我们的效果<img src="https://user-gold-cdn.xitu.io/2017/12/5/1602515aa08828e3?w=2490&amp;h=452&amp;f=png&amp;s=82903" alt="代码运行效果"></p>
<ul>
<li><p>假如我们还有一个需求，我们需要用AOP对某些请求进行拦截，那我们也可以将注解作为切面，将需要拦截的方法增加注解的方式进行拦截，并且可以将注解的信息解析出来在切面进行使用。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"> /**</span><br><span class="line"> * Created by buzheng on 17/12/5.</span><br><span class="line"> */</span><br><span class="line">@Inherited</span><br><span class="line">@Documented</span><br><span class="line">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">@Target(ElementType.METHOD)</span><br><span class="line">public @interface LogAnnotation &#123;</span><br><span class="line">  /**</span><br><span class="line">    * 操作</span><br><span class="line">    * @return</span><br><span class="line">    */</span><br><span class="line">   String operateType() default &quot;默认操作&quot;;</span><br><span class="line"></span><br><span class="line">   /**</span><br><span class="line">    * 操作人员工号ID</span><br><span class="line">    * @return</span><br><span class="line">    */</span><br><span class="line">   int workId();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用AOP的方式使用注解</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">* Created by buzheng on 17/12/5.</span><br><span class="line">*/</span><br><span class="line">@Aspect</span><br><span class="line">@Component</span><br><span class="line">public class MyAspect &#123;</span><br><span class="line"></span><br><span class="line">    private Logger logger = LoggerFactory.getLogger(MyAspect.class);</span><br><span class="line"></span><br><span class="line">    @Pointcut(&quot;@annotation(com.buzheng.LogAnnotation)&quot;)</span><br><span class="line">    public void logPointCount() &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Around(&quot;logPointCount()&quot;)</span><br><span class="line">    public Object actionLog(ProceedingJoinPoint joinPoint) &#123;</span><br><span class="line">        Object res = new Object();</span><br><span class="line">        try &#123;</span><br><span class="line">            //获取注解的各种信息</span><br><span class="line">            LogAnnotation logAnnotation = getAnnotation(joinPoint);</span><br><span class="line">            String operateType = logAnnotation.operateType();</span><br><span class="line">            int workId = logAnnotation.workId();</span><br><span class="line">            //然后你想做点什么，比如打个log</span><br><span class="line">            logger.warn(&quot;操作类型变更:&quot; + operateType + &quot;变更人工号:&quot; + workId);</span><br><span class="line">            res = joinPoint.proceed();</span><br><span class="line">        &#125; catch (Throwable throwable) &#123;</span><br><span class="line">            logger.error(&quot;aop is failed&quot;, throwable);</span><br><span class="line">        &#125;</span><br><span class="line">        return res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 获取注解信息</span><br><span class="line">     *</span><br><span class="line">     * @param joinPoint</span><br><span class="line">     * @return</span><br><span class="line">     * @throws Exception</span><br><span class="line">     */</span><br><span class="line">    public LogAnnotation getAnnotation(ProceedingJoinPoint joinPoint) throws Exception &#123;</span><br><span class="line">        Signature signature = joinPoint.getSignature();</span><br><span class="line">        MethodSignature methodSignature = (MethodSignature) signature;</span><br><span class="line">        Method method = methodSignature.getMethod();</span><br><span class="line">        boolean flag = method.isAnnotationPresent(LogAnnotation.class);</span><br><span class="line">        if (flag) &#123;</span><br><span class="line">            LogAnnotation logAnnotation = (LogAnnotation) method.getAnnotation(LogAnnotation.class);</span><br><span class="line">            return logAnnotation;</span><br><span class="line">        &#125;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/12/10/Java-ClassLoader/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="不正">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/10/Java-ClassLoader/" itemprop="url">Java-关于类加载器</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-12-10T23:37:44+08:00">
                2017-12-10
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="一、什么是-ClassLoader-？"><a href="#一、什么是-ClassLoader-？" class="headerlink" title="一、什么是 ClassLoader ？"></a>一、什么是 ClassLoader ？</h3><ul>
<li><p>什么是ClassLoader </p>
<p>当代码编写完成之后，我们会写很多的以Java文件，而这些Java文件会被编译生成class文件，class文件被需要被经历一系列的流程才能够进行使用与卸载。而在程序启动的时候，所有的class文件并不会一次性加载，而是在需要的时候，根据Java的类加载机制进行动态加载。而完成对class文件加载操作的，就是ClassLoader。</p>
</li>
<li><p>ClassLoader的作用</p>
<ul>
<li>将类加载到内存中</li>
<li>决定类是由哪个类加载器进行加载</li>
<li>将class文件中的信息解析成对象</li>
</ul>
</li>
</ul>
<h3 id="二、分析ClassLoader"><a href="#二、分析ClassLoader" class="headerlink" title="二、分析ClassLoader"></a>二、分析ClassLoader</h3><ul>
<li><p>ClassLoader的类型</p>
<ul>
<li>BootstrapClassLoader </li>
<li>ExtClassLoader   </li>
<li>AppClassLoader  </li>
</ul>
<p>其中3个ClassLoader各自负责加载的区域不同，如下代码所示:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 测试classloader的加载范围</span><br><span class="line"> */</span><br><span class="line">private void testClassLoader()&#123;</span><br><span class="line">    /**</span><br><span class="line">     * BootstrapClassLoader 加载  jre/lib</span><br><span class="line">     */</span><br><span class="line">    System.out.println(System.getProperty(&quot;sun.boot.class.path&quot;));</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Extention ClassLoader   jre/lib/ext</span><br><span class="line">     */</span><br><span class="line">    System.out.println(System.getProperty(&quot;java.ext.dirs&quot;));</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * AppClassLoader  bin目录</span><br><span class="line">     */</span><br><span class="line">    System.out.println(System.getProperty(&quot;java.class.path&quot;));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p> 通过以上代码，我们可以看到每个ClassLoader的加载范围是不一样的，其中BootStrapClassLoder加载的是jre/lib目录下的jar包，这些比如rat.jar等等。而ExtClassLoader负责加载的是jre/lib/ext目录下的jar包，而AppClassLoader主要加载的是我们定义的类的class文件。</p>
<ul>
<li><p>ClassLoader的加载机制<br>ClassLoder的继承关系图如下所示：<br><img src="https://user-gold-cdn.xitu.io/2017/12/7/1603172695147f2f?w=591&amp;h=552&amp;f=png&amp;s=29094" alt="ClassLoader继承关系图"></p>
<p>而当我们看到ClassLoder的源码的时候，我们可以看到：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">   * Loads the class with the specified &lt;a href=&quot;#name&quot;&gt;binary name&lt;/a&gt;.  The</span><br><span class="line">   * default implementation of this method searches for classes in the</span><br><span class="line">   * following order:</span><br><span class="line">   *</span><br><span class="line">   * &lt;ol&gt;</span><br><span class="line">   *</span><br><span class="line">   *   &lt;li&gt;&lt;p&gt; Invoke &#123;@link #findLoadedClass(String)&#125; to check if the class</span><br><span class="line">   *   has already been loaded.  &lt;/p&gt;&lt;/li&gt;</span><br><span class="line">   *</span><br><span class="line">   *   &lt;li&gt;&lt;p&gt; Invoke the &#123;@link #loadClass(String) &lt;tt&gt;loadClass&lt;/tt&gt;&#125; method</span><br><span class="line">   *   on the parent class loader.  If the parent is &lt;tt&gt;null&lt;/tt&gt; the class</span><br><span class="line">   *   loader built-in to the virtual machine is used, instead.  &lt;/p&gt;&lt;/li&gt;</span><br><span class="line">   *</span><br><span class="line">   *   &lt;li&gt;&lt;p&gt; Invoke the &#123;@link #findClass(String)&#125; method to find the</span><br><span class="line">   *   class.  &lt;/p&gt;&lt;/li&gt;</span><br><span class="line">   *</span><br><span class="line">   * &lt;/ol&gt;</span><br><span class="line">   *</span><br><span class="line">   * &lt;p&gt; If the class was found using the above steps, and the</span><br><span class="line">   * &lt;tt&gt;resolve&lt;/tt&gt; flag is true, this method will then invoke the &#123;@link</span><br><span class="line">   * #resolveClass(Class)&#125; method on the resulting &lt;tt&gt;Class&lt;/tt&gt; object.</span><br><span class="line">   *</span><br><span class="line">   * &lt;p&gt; Subclasses of &lt;tt&gt;ClassLoader&lt;/tt&gt; are encouraged to override &#123;@link</span><br><span class="line">   * #findClass(String)&#125;, rather than this method.  &lt;/p&gt;</span><br><span class="line">   *</span><br><span class="line">   * &lt;p&gt; Unless overridden, this method synchronizes on the result of</span><br><span class="line">   * &#123;@link #getClassLoadingLock &lt;tt&gt;getClassLoadingLock&lt;/tt&gt;&#125; method</span><br><span class="line">   * during the entire class loading process.</span><br><span class="line">   *</span><br><span class="line">   * @param  name</span><br><span class="line">   *         The &lt;a href=&quot;#name&quot;&gt;binary name&lt;/a&gt; of the class</span><br><span class="line">   *</span><br><span class="line">   * @param  resolve</span><br><span class="line">   *         If &lt;tt&gt;true&lt;/tt&gt; then resolve the class</span><br><span class="line">   *</span><br><span class="line">   * @return  The resulting &lt;tt&gt;Class&lt;/tt&gt; object</span><br><span class="line">   *</span><br><span class="line">   * @throws  ClassNotFoundException</span><br><span class="line">   *          If the class could not be found</span><br><span class="line">   */</span><br><span class="line">  protected Class&lt;?&gt; loadClass(String name, boolean resolve)</span><br><span class="line">      throws ClassNotFoundException</span><br><span class="line">  &#123;</span><br><span class="line">      synchronized (getClassLoadingLock(name)) &#123;</span><br><span class="line">          // First, check if the class has already been loaded</span><br><span class="line">          Class&lt;?&gt; c = findLoadedClass(name);</span><br><span class="line">          if (c == null) &#123;</span><br><span class="line">              long t0 = System.nanoTime();</span><br><span class="line">              try &#123;</span><br><span class="line">                  if (parent != null) &#123;</span><br><span class="line">                      c = parent.loadClass(name, false);</span><br><span class="line">                  &#125; else &#123;</span><br><span class="line">                      c = findBootstrapClassOrNull(name);</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125; catch (ClassNotFoundException e) &#123;</span><br><span class="line">                  // ClassNotFoundException thrown if class not found</span><br><span class="line">                  // from the non-null parent class loader</span><br><span class="line">              &#125;</span><br><span class="line"></span><br><span class="line">              if (c == null) &#123;</span><br><span class="line">                  // If still not found, then invoke findClass in order</span><br><span class="line">                  // to find the class.</span><br><span class="line">                  long t1 = System.nanoTime();</span><br><span class="line">                  c = findClass(name);</span><br><span class="line"></span><br><span class="line">                  // this is the defining class loader; record the stats</span><br><span class="line">                  sun.misc.PerfCounter.getParentDelegationTime().addTime(t1 - t0);</span><br><span class="line">                  sun.misc.PerfCounter.getFindClassTime().addElapsedTimeFrom(t1);</span><br><span class="line">                  sun.misc.PerfCounter.getFindClasses().increment();</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          if (resolve) &#123;</span><br><span class="line">              resolveClass(c);</span><br><span class="line">          &#125;</span><br><span class="line">          return c;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>  简单翻译一下类加载的过程：</p>
<ul>
<li>首先当需要加载类的时候，先检查需要加载的类是否已经加载。</li>
<li>如果还没加载，自己不会去尝试加载类，而是将类加载的任务委托给了parentClass，向上进行类的查找过程。</li>
<li><p>如果向上委托后，找到最顶上的BootStrapClassLoader类进行加载，如果没有加载到会交给下一级ExtClassLoader进行加载，如果在此从上到下查找的过程中查找到，则会将类加载到内存中，如果没有找到，会交给发起委托的类加载器，由它去指定的文件系统等进行查找加载，如果还是没有找到，则抛出ClassNotFound的异常。</p>
<p>从上面可以看到的是，类的加载过程先由加载发起者进行向上委托，然后再由顶上的类加载器进行查找返回，找不到就自己加载的过程，这种加载的过程我们称作双亲委派机制。</p>
<p>但是仔细一想，不对呀，假如AppClassLoader需要加载一个类的时候，会向上委托到ExtClassLoader，然后再向上委托给BootStrapClassLoader。如下代码所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">  * 类加载过程</span><br><span class="line">  */</span><br><span class="line"> private static void parentDelegation()&#123;</span><br><span class="line">     ClassLoader classLoader = Test.class.getClassLoader(); //app</span><br><span class="line">     System.out.println(classLoader);</span><br><span class="line">     ClassLoader parentClassLoader = classLoader.getParent(); //ext</span><br><span class="line">     System.out.println(parentClassLoader);</span><br><span class="line">     ClassLoader parentParentClassLoader = parentClassLoader.getParent(); //null</span><br><span class="line">     System.out.println(parentParentClassLoader);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>  <img src="https://user-gold-cdn.xitu.io/2017/12/7/1603172695b5f873?w=839&amp;h=150&amp;f=png&amp;s=27078" alt="执行结果"></p>
<p>  我们可以看到，输出结果除了null确实跟我们设想的一样，但是为什么BootStrapClassLoader为空呢，其实是因为BootStrapClassLoader是一个native的实现，所以在这里输出是null。但是仔细一想貌似还是不对，因为从我们上面给出的ClassLoader继承关系图，我们看到这几个ClassLoader没有继承关系，那为啥叫双亲委派，从代码中我们可以看到这个“亲”的定义：</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">protected ClassLoader(ClassLoader parent) &#123;</span><br><span class="line">     this(checkCreateClassLoader(), parent);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>  原来，是在产生一个类加载器的时候，通过传入parent指定了该ClassLoader的亲是哪个ClassLoader。它们之前是没有任何的继承关系的。</p>
<ul>
<li><p>双亲委派的作用是什么？</p>
<p> 从上面可以看到，ClassLoader采用的是双亲委派机制，那到底有什么作用呢？</p>
<ul>
<li><p>减少重复加载</p>
<p>在双亲委派机制中，当它的parentClassLoader已经加载了该类的时候，就没必要自己再加载一遍了，可以减少重复加载的可能性。</p>
</li>
<li><p>安全</p>
<p> 假如没有双亲委派机制，那我们就可以随意让自定义的ClassLoader去加载经过改造的系统的类，比如String，这是一件非常危险的事情，而有双亲委派的时候，因为String类已经被加载过，所以就不能被我们自定义的ClassLoader加载。</p>
</li>
</ul>
</li>
<li><p>ClassLoder常见方法</p>
<ul>
<li>Class&lt;?&gt; defineClass(byte[] b, int off, int len) 表示将一个byte数组中的内容转换成一个类的实例。</li>
<li>Class&lt;?&gt; findClass(String name) 从指定的位置查找类，返回一个类的实例。（自定义类加载器主要实现该方法）</li>
<li>Class&lt;?&gt; loadClass(String name) 从指定的位置加载类。</li>
</ul>
</li>
</ul>
<h3 id="三、实现自定义ClassLoader"><a href="#三、实现自定义ClassLoader" class="headerlink" title="三、实现自定义ClassLoader"></a>三、实现自定义ClassLoader</h3><p> 前面已经描述了ClassLoader的作用以及加载的过程，而当我们需要自定义一个ClassLoder去加载我们自己的类并执行某些操作的时候，就需要实现自定义ClassLoder。</p>
<ul>
<li>首先需要继承ClassLoader类</li>
<li>实现自定义的findClass方法</li>
</ul>
<p>以下代码为例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Created by buzheng on 17/12/7.</span><br><span class="line"> */</span><br><span class="line">public class TestClassLoader &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            MyClassLoder myClassLoder = new MyClassLoder();</span><br><span class="line">            Class clazz = myClassLoder.loadClass(&quot;com.buzheng.class_test.TestClassLoader&quot;);</span><br><span class="line">            Object object = clazz.newInstance();</span><br><span class="line">            Method method = clazz.getMethod(&quot;say&quot;, null);</span><br><span class="line">            Object o = method.invoke(object, null);</span><br><span class="line">            System.out.println(o);</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 定义一个方法</span><br><span class="line">     *</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    public String say() &#123;</span><br><span class="line">        return &quot;here&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    static class MyClassLoder extends ClassLoader &#123;</span><br><span class="line">        @Override</span><br><span class="line">        protected Class&lt;?&gt; findClass(String name) throws ClassNotFoundException &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                String classPath = name.substring(name.lastIndexOf(&quot;.&quot;) + 1) + &quot;.class&quot;;</span><br><span class="line">                InputStream is = getClass().getResourceAsStream(classPath);</span><br><span class="line">                if (is == null) &#123;</span><br><span class="line">                    return super.findClass(name);</span><br><span class="line">                &#125;</span><br><span class="line">                byte[] b = new byte[is.available()];</span><br><span class="line">                return defineClass(name, b, 0, b.length);</span><br><span class="line"></span><br><span class="line">            &#125; catch (IOException e) &#123;</span><br><span class="line">                return super.findClass(name);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行main方法可以看到，我们确实自定义了一个类加载器，并且将字节码文件转为字节流进行自定义加载。<br><img src="https://user-gold-cdn.xitu.io/2017/12/7/16031726989504d1?w=785&amp;h=148&amp;f=png&amp;s=18372" alt="执行结果"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/12/10/Java-泛型/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="不正">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/10/Java-泛型/" itemprop="url">关于Java中的泛型</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-12-10T23:37:16+08:00">
                2017-12-10
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="一、什么是泛型"><a href="#一、什么是泛型" class="headerlink" title="一、什么是泛型"></a>一、什么是泛型</h4><p>开发中，经常会用到泛型，泛型是在JDK5之后的一个新特性，允许定义类、接口等的是实用类型参数。</p>
<p>泛型的出现，使得从需要在代码里面增加判断以及类型转化的事情交给编译器去解决，如下代码所示，当没有泛型的时候,代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">List nonGenerics = new ArrayList();</span><br><span class="line">       nonGenerics.add(&quot;buzheng&quot;);</span><br><span class="line">       Object nonGenericsObject = nonGenerics.get(0);</span><br><span class="line">       if (nonGenericsObject != null) &#123;</span><br><span class="line">           //进行类型判断</span><br><span class="line">           if (nonGenericsObject instanceof String) &#123;</span><br><span class="line">               //进行类型转换</span><br><span class="line">               String s = (String) nonGenericsObject;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>
<p>而当使用泛型的时候，可以看到的是我们的代码更加简洁：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; nonGenerics = new ArrayList();</span><br><span class="line">nonGenerics.add(&quot;buzheng&quot;);</span><br><span class="line">String s = nonGenerics.get(0);</span><br></pre></td></tr></table></figure>
<p>这就是泛型带给我们代码的书写以及规范上的好处。</p>
<h4 id="二、泛型到底怎么玩的"><a href="#二、泛型到底怎么玩的" class="headerlink" title="二、泛型到底怎么玩的"></a>二、泛型到底怎么玩的</h4><p>首先先执行以下的代码，我们看看输出的效果:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">//类型参数为String</span><br><span class="line">       List&lt;String&gt; stringList = new ArrayList&lt;&gt;();</span><br><span class="line">       //类型参数为Integer</span><br><span class="line">       List&lt;Integer&gt; integerList = new ArrayList&lt;&gt;();</span><br><span class="line">       Class clazzStringList = stringList.getClass();</span><br><span class="line">       Class clazzIntegerList = integerList.getClass();</span><br><span class="line">       //看看两个类是否是共同的类</span><br><span class="line">       System.out.println(clazzIntegerList == clazzStringList);</span><br></pre></td></tr></table></figure>
<p>按照正常来讲，这里的输出应该是false，但是实际上是true，因此可以猜想，为什么类型居然一样了，明明类型参数都不一样的。</p>
<p>接下来为了验证我们的猜想，我们再通过如下代码进行验证。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Created by buzheng on 17/12/8.</span><br><span class="line"> */</span><br><span class="line">public class TestGenerics &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            //类型参数为String</span><br><span class="line">            List&lt;String&gt; stringList = new ArrayList&lt;&gt;();</span><br><span class="line">            stringList.add(&quot;hello&quot;);</span><br><span class="line">            Class clazzStringList = stringList.getClass();</span><br><span class="line">            Method method = clazzStringList.getMethod(&quot;add&quot;, Object.class);</span><br><span class="line">            //加入一个int类型</span><br><span class="line">            method.invoke(stringList, 1);</span><br><span class="line">            System.out.println(stringList);</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看一下我们的输出结果：<img src="https://user-gold-cdn.xitu.io/2017/12/8/1603647b17589664?w=1163&amp;h=300&amp;f=png&amp;s=26802" alt="输出结果"></p>
<p>可以看到的是，我们通过反射，在运行期给stringList加入类型为Integer类型的数值，是没有问题的。由此我们可以猜测在运行期的时候，作用在stringList上的类型参数是否可能被编译之后给去除掉了。</p>
<p>没错，如上面的两段代码所示：我们可以初步得出一个结论：<strong>泛型在编译之后进行了类型擦除</strong></p>
<ul>
<li><p>什么是类型擦除？</p>
<p>前面说到过泛型是在JDK5之后引入的，为了兼容5之前的代码，虚拟机会将我们使用的泛型进行擦除，还原为原始类型。所以,<strong>Java的泛型是一种伪泛型，</strong>以下面的代码为例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> /**</span><br><span class="line"> * Created by buzheng on 17/12/8.</span><br><span class="line"> */</span><br><span class="line">public class TestGenerics &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        List&lt;String&gt; stringList = new ArrayList();</span><br><span class="line">        stringList.add(&quot;123&quot;);</span><br><span class="line">        System.out.println(stringList.get(0));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p> 我们反编译看下这个class文件编译之后变成什么样子？</p>
<p> <img src="https://user-gold-cdn.xitu.io/2017/12/8/1603647b1ba1f223?w=1106&amp;h=708&amp;f=png&amp;s=60177" alt="反编译class文件"></p>
<p> 可以确确实实的看到，我们的类型确实是被擦除了，原先的String类型已经变成了Object类型。</p>
<ul>
<li><p>既然擦除了类型参数，为什么我们不需要强转？</p>
<p>按照常理来讲，在class文件中，我们的类型信息已经被擦除了，那么返回的类型就是Object类型，但是为什么我们不需要进行强转就能得到正确的结果呢？</p>
<p>在Java虚拟机中，class文件是以特殊格式存在的文件，我们查看一下字节码的文件信息，如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"> Classfile /Users/buzheng/Desktop/TestGenerics.class</span><br><span class="line">  Last modified 2017-12-8; size 882 bytes</span><br><span class="line">  MD5 checksum 3f753fc7b9100702e8238181e9695a7e</span><br><span class="line">  Compiled from &quot;TestGenerics.java&quot;</span><br><span class="line">public class com.buzheng.generics.TestGenerics</span><br><span class="line">  minor version: 0</span><br><span class="line">  major version: 52</span><br><span class="line">  flags: ACC_PUBLIC, ACC_SUPER</span><br><span class="line">Constant pool:</span><br><span class="line">   #1 = Methodref          #11.#29        // java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span><br><span class="line">   #2 = Class              #30            // java/util/ArrayList</span><br><span class="line">   #3 = Methodref          #2.#29         // java/util/ArrayList.&quot;&lt;init&gt;&quot;:()V</span><br><span class="line">   #4 = String             #31            // 123</span><br><span class="line">   #5 = InterfaceMethodref #32.#33        // java/util/List.add:(Ljava/lang/Object;)Z</span><br><span class="line">   #6 = Fieldref           #34.#35        // java/lang/System.out:Ljava/io/PrintStream;</span><br><span class="line">   #7 = InterfaceMethodref #32.#36        // java/util/List.get:(I)Ljava/lang/Object;</span><br><span class="line">   #8 = Class              #37            // java/lang/String</span><br><span class="line">   #9 = Methodref          #38.#39        // java/io/PrintStream.println:(Ljava/lang/String;)V</span><br><span class="line">  #10 = Class              #40            // com/buzheng/generics/TestGenerics</span><br><span class="line">  #11 = Class              #41            // java/lang/Object</span><br><span class="line">  #12 = Utf8               &lt;init&gt;</span><br><span class="line">  #13 = Utf8               ()V</span><br><span class="line">  #14 = Utf8               Code</span><br><span class="line">  #15 = Utf8               LineNumberTable</span><br><span class="line">  #16 = Utf8               LocalVariableTable</span><br><span class="line">  #17 = Utf8               this</span><br><span class="line">  #18 = Utf8               Lcom/buzheng/generics/TestGenerics;</span><br><span class="line">  #19 = Utf8               main</span><br><span class="line">  #20 = Utf8               ([Ljava/lang/String;)V</span><br><span class="line">  #21 = Utf8               args</span><br><span class="line">  #22 = Utf8               [Ljava/lang/String;</span><br><span class="line">  #23 = Utf8               stringList</span><br><span class="line">  #24 = Utf8               Ljava/util/List;</span><br><span class="line">  #25 = Utf8               LocalVariableTypeTable</span><br><span class="line">  #26 = Utf8               Ljava/util/List&lt;Ljava/lang/String;&gt;;</span><br><span class="line">  #27 = Utf8               SourceFile</span><br><span class="line">  #28 = Utf8               TestGenerics.java</span><br><span class="line">  #29 = NameAndType        #12:#13        // &quot;&lt;init&gt;&quot;:()V</span><br><span class="line">  #30 = Utf8               java/util/ArrayList</span><br><span class="line">  #31 = Utf8               123</span><br><span class="line">  #32 = Class              #42            // java/util/List</span><br><span class="line">  #33 = NameAndType        #43:#44        // add:(Ljava/lang/Object;)Z</span><br><span class="line">  #34 = Class              #45            // java/lang/System</span><br><span class="line">  #35 = NameAndType        #46:#47        // out:Ljava/io/PrintStream;</span><br><span class="line">  #36 = NameAndType        #48:#49        // get:(I)Ljava/lang/Object;</span><br><span class="line">  #37 = Utf8               java/lang/String</span><br><span class="line">  #38 = Class              #50            // java/io/PrintStream</span><br><span class="line">  #39 = NameAndType        #51:#52        // println:(Ljava/lang/String;)V</span><br><span class="line">  #40 = Utf8               com/buzheng/generics/TestGenerics</span><br><span class="line">  #41 = Utf8               java/lang/Object</span><br><span class="line">  #42 = Utf8               java/util/List</span><br><span class="line">  #43 = Utf8               add</span><br><span class="line">  #44 = Utf8               (Ljava/lang/Object;)Z</span><br><span class="line">  #45 = Utf8               java/lang/System</span><br><span class="line">  #46 = Utf8               out</span><br><span class="line">  #47 = Utf8               Ljava/io/PrintStream;</span><br><span class="line">  #48 = Utf8               get</span><br><span class="line">  #49 = Utf8               (I)Ljava/lang/Object;</span><br><span class="line">  #50 = Utf8               java/io/PrintStream</span><br><span class="line">  #51 = Utf8               println</span><br><span class="line">  #52 = Utf8               (Ljava/lang/String;)V</span><br><span class="line">&#123;</span><br><span class="line">  public com.buzheng.generics.TestGenerics();</span><br><span class="line">    descriptor: ()V</span><br><span class="line">    flags: ACC_PUBLIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=1, locals=1, args_size=1</span><br><span class="line">         0: aload_0</span><br><span class="line">         1: invokespecial #1                  // Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span><br><span class="line">         4: return</span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line 9: 0</span><br><span class="line">      LocalVariableTable:</span><br><span class="line">        Start  Length  Slot  Name   Signature</span><br><span class="line">            0       5     0  this   Lcom/buzheng/generics/TestGenerics;</span><br><span class="line"></span><br><span class="line">  public static void main(java.lang.String[]);</span><br><span class="line">    descriptor: ([Ljava/lang/String;)V</span><br><span class="line">    flags: ACC_PUBLIC, ACC_STATIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=3, locals=2, args_size=1</span><br><span class="line">         0: new           #2                  // class java/util/ArrayList</span><br><span class="line">         3: dup</span><br><span class="line">         4: invokespecial #3                  // Method java/util/ArrayList.&quot;&lt;init&gt;&quot;:()V</span><br><span class="line">         7: astore_1</span><br><span class="line">         8: aload_1</span><br><span class="line">         9: ldc           #4                  // String 123</span><br><span class="line">        11: invokeinterface #5,  2            // InterfaceMethod java/util/List.add:(Ljava/lang/Object;)Z</span><br><span class="line">        16: pop</span><br><span class="line">        17: getstatic     #6                  // Field java/lang/System.out:Ljava/io/PrintStream;</span><br><span class="line">        20: aload_1</span><br><span class="line">        21: iconst_0</span><br><span class="line">        22: invokeinterface #7,  2            // InterfaceMethod java/util/List.get:(I)Ljava/lang/Object;</span><br><span class="line">        27: checkcast     #8                  // class java/lang/String</span><br><span class="line">        30: invokevirtual #9                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V</span><br><span class="line">        33: return</span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line 11: 0</span><br><span class="line">        line 12: 8</span><br><span class="line">        line 13: 17</span><br><span class="line">        line 14: 33</span><br><span class="line">      LocalVariableTable:</span><br><span class="line">        Start  Length  Slot  Name   Signature</span><br><span class="line">            0      34     0  args   [Ljava/lang/String;</span><br><span class="line">            8      26     1 stringList   Ljava/util/List;</span><br><span class="line">      LocalVariableTypeTable:</span><br><span class="line">        Start  Length  Slot  Name   Signature</span><br><span class="line">            8      26     1 stringList   Ljava/util/List&lt;Ljava/lang/String;&gt;;</span><br><span class="line">&#125;</span><br><span class="line">SourceFile: &quot;TestGenerics.java</span><br></pre></td></tr></table></figure>
<p>在上述的字节码信息中，可以看到我们调用get方法的时候，确确实实是先返回了object类型</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">22: invokeinterface #7,  2            // InterfaceMethod java/util/List.get:(I)Ljava/lang/Object;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>  然后下面有一个checkcast，很明显这是一个判断是否需要进行类型转换的标志，checkcast指向了常量池的#8，而刚好对应的是</p>
<pre><code><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#8 = Class              #37            // java/lang/	String</span><br></pre></td></tr></table></figure>
</code></pre><p>原来虚拟机在会先在编译完成的class文件中记录下泛型的信息，虽然编译后擦除了，但是记录在了字节码文件中，等到执行的时候会先checkcast进行类型转换，到此，泛型是如何进行擦除又能准确的帮助我们进行类型转换就很清晰了。</p>
<h4 id="三、最后的最后，类型擦除的过程是怎么样的优先级？"><a href="#三、最后的最后，类型擦除的过程是怎么样的优先级？" class="headerlink" title="三、最后的最后，类型擦除的过程是怎么样的优先级？"></a>三、最后的最后，类型擦除的过程是怎么样的优先级？</h4><ul>
<li>首先找到替换类型参数的具体类，如果泛型没有extends任何的上限类，那么就是Object</li>
<li>如果泛型extends了上限类，比如 T extends List，那么就是List了</li>
<li>最后将找到的替换类替换掉泛型，生成信息或者桥接方法在字节码文件中</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/12/10/Java-ThreadLocal/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="不正">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/10/Java-ThreadLocal/" itemprop="url">Java-关于ThreadLocal的那点事</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-12-10T23:36:44+08:00">
                2017-12-10
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="一、什么是ThreadLocal"><a href="#一、什么是ThreadLocal" class="headerlink" title="一、什么是ThreadLocal"></a>一、什么是ThreadLocal</h4><ul>
<li><strong>ThreadLocal</strong></li>
</ul>
<p>在网上许多的文章都是这么解释的，ThreadLocal提供了一种多线程并发处理共享变量的一种安全的解决思路。但是仔细查看代码之后，发现ThreadLocal更准确来讲，是提供了一种不同的线程之间，彼此的变量相互隔离，互不干扰的一种便于线程自己变量使用的方式。</p>
<ul>
<li><strong>简单例子</strong></li>
</ul>
<p>假如有一个银行，银行对客户的钱是存放在每个客户的存款账号里面，不同的客户对自己的钱进行消费存储。</p>
<p>okay，我们类比一下ThreadLocal，当银行是一个ThreadLocal，每个用户是一个线程，ThreadLocal往不同的客户（线程）创建不同的账户（变量副本），然后每个用户存取钱的时候，实际上是往自己的账户存取钱，那么也就不会影响到其他用户的账户了。</p>
<p>我们再拓展一下，上面我们说了一个银行，但是银行很多呀，那也就意味着每个线程都是可以有多个ThreadLocal的，所以理解下来就变成了，线程里面存着多个由不同的ThreadLocal存储着对应的变量副本。<br>关系如下图所示：<br><img src="http://upload-images.jianshu.io/upload_images/1428117-8346ff36fbe906e2.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="ThreadLocal关系图"></p>
<h4 id="二、ThreadLocal有什么作用？"><a href="#二、ThreadLocal有什么作用？" class="headerlink" title="二、ThreadLocal有什么作用？"></a>二、ThreadLocal有什么作用？</h4><p>举个例子，分析一下ThreadLocal的作用。</p>
<p>假如我们有这样的一个场景，我们需要对用户的操作日志进行存储，用户的请求可能同一时刻打过来的，假设我们只有一台服务器，这台服务器处理该请求的tps是100，每个请求处理时间是10ms，一个线程可以处理10个tps，那我们可以知道服务器同时开启的线程数应该是10个。那并发情况下，10个请求同时打过来，不同请求用户的访问参数是不一样的，比如用户的ID，昵称，业务类型都是不一样的，所以对于我们需要记录用户操作而言，每个线程都需要一个自己的变量副本才不会跟其他线程因为修改了同样的变量而导致不安全的现象，那么ThreadLocal就可以派上用场了，因为ThreadLocal会在这十个线程里面设置变量副本，不同线程里面的变量副本自己维护，所以就不会存在数据竞争的情况发生。</p>
<ul>
<li>通过一个小例子验证，ThreadLocal确实是能隔离变量的</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"> package com.buzheng.threadlocaltest;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * created by buzheng</span><br><span class="line"> * ThreadLocal测试demo</span><br><span class="line"> */</span><br><span class="line">public class ThreadLocalTest &#123;</span><br><span class="line"></span><br><span class="line">    private ThreadLocal&lt;Long&gt; longThreadLocal = new ThreadLocal&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    private ThreadLocal&lt;String&gt; stringThreadLocal = new ThreadLocal&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    public void setThreadLocalVaule() &#123;</span><br><span class="line">        longThreadLocal.set(Thread.currentThread().getId());</span><br><span class="line">        stringThreadLocal.set(Thread.currentThread().getName());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Long getThreadId() &#123;</span><br><span class="line">        return longThreadLocal.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getThreadName() &#123;</span><br><span class="line">        return stringThreadLocal.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        ThreadLocalTest threadLocalTest = new ThreadLocalTest();</span><br><span class="line">        threadLocalTest.setThreadLocalVaule();</span><br><span class="line">        show(&quot;the threadLocal&apos;s name is &quot; + threadLocalTest.getThreadId() + &quot;   the threadLocal&apos;s id is &quot; + threadLocalTest.getThreadName());</span><br><span class="line">        new Thread(new Runnable() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void run() &#123;</span><br><span class="line">                threadLocalTest.setThreadLocalVaule();</span><br><span class="line">                show(&quot;the threadLocal&apos;s name is &quot; + threadLocalTest.getThreadId() + &quot;   the threadLocal&apos;s id is &quot; + threadLocalTest.getThreadName());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void show(Object object) &#123;</span><br><span class="line">        System.out.println(object);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 上述代码的输出结果是<img src="http://upload-images.jianshu.io/upload_images/1428117-80f21cdaa413f53a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="运行结果"><br> 我们可以看到，确实不同线程里面的变量是独立维护的，主线程跟子线程里自己有自己的一份变量副本，自己维护，互不打扰。</p>
<h4 id="三、ThreadLocal到底是如何工作的"><a href="#三、ThreadLocal到底是如何工作的" class="headerlink" title="三、ThreadLocal到底是如何工作的"></a>三、ThreadLocal到底是如何工作的</h4><p>在ThreadLocal的源码中，我们可以看到，ThreadLocal的类定义是酱紫的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * This class provides thread-local variables.  These variables differ from</span><br><span class="line"> * their normal counterparts in that each thread that accesses one (via its</span><br><span class="line"> * &#123;@code get&#125; or &#123;@code set&#125; method) has its own, independently initialized</span><br><span class="line"> * copy of the variable.  &#123;@code ThreadLocal&#125; instances are typically private</span><br><span class="line"> * static fields in classes that wish to associate state with a thread ...</span><br><span class="line"> */</span><br></pre></td></tr></table></figure>
<p>简单翻译一下：ThreadLocal提供了线程自己的本地变量。当不同线程访问这些变量的时候，每个线程访问的变量都是不一样的，访问的变量是取决于线程的变量副本。ThreadLocal实例通常来说都是private static类型的，用于关联线程和线程的上下文。</p>
<p>那简单看一下ThreadLocal是如何工作的，如果我们自己设计的话，最简单的做法就是我们给每个ThreadLocal类创建一个Map<long,object>，key是Thread的ID，Object是需要存储的线程的数据，但是Java的设计并非这么简单，而且刚好是相反的。</long,object></p>
<ul>
<li><p>get（）方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Returns the value in the current thread&apos;s copy of this</span><br><span class="line"> * thread-local variable.  If the variable has no value for the</span><br><span class="line"> * current thread, it is first initialized to the value returned</span><br><span class="line"> * by an invocation of the &#123;@link #initialValue&#125; method.</span><br><span class="line"> *</span><br><span class="line"> * @return the current thread&apos;s value of this thread-local</span><br><span class="line"> */</span><br><span class="line">public T get() &#123;</span><br><span class="line">    Thread t = Thread.currentThread();</span><br><span class="line">    ThreadLocalMap map = getMap(t);</span><br><span class="line">    if (map != null) &#123;</span><br><span class="line">        ThreadLocalMap.Entry e = map.getEntry(this);</span><br><span class="line">        if (e != null) &#123;</span><br><span class="line">            @SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">            T result = (T)e.value;</span><br><span class="line">            return result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return setInitialValue();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从上面我们可以看到get()方法做了以下的事情</p>
<ul>
<li>获取当前的线程t</li>
<li>调用getMap(t)方法获取当前线程的所有的变量副本ThreadLocalMap</li>
<li>从ThreadLocalMap取出当前ThreadLocal的数据返回</li>
<li>如果值为空的话，说明未设置，那么调用setInitialValue进行初始化。</li>
</ul>
</li>
<li><p>看一下ThreadLcolMap是什么东西</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Get the map associated with a ThreadLocal. Overridden in</span><br><span class="line"> * InheritableThreadLocal.</span><br><span class="line"> *</span><br><span class="line"> * @param  t the current thread</span><br><span class="line"> * @return the map</span><br><span class="line"> */</span><br><span class="line">ThreadLocalMap getMap(Thread t) &#123;</span><br><span class="line">    return t.threadLocals;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在代码里面我们可以看到，getMap返回的是ThreadLocal关联的Map，简单来说ThreadLocalMap就是跟当前线程存储的一个映射表，这个映射表存储了当前线程所有的ThreadLocal的数据。<br>我们再往下看一下ThreadLocalMap类的定义，我们可以看到ThreadLocalMap是ThreadLocal的一个内部类。这个内部类的构造函数如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">   * Construct a new map initially containing (firstKey, firstValue).</span><br><span class="line">   * ThreadLocalMaps are constructed lazily, so we only create</span><br><span class="line">   * one when we have at least one entry to put in it.</span><br><span class="line">   */</span><br><span class="line">  ThreadLocalMap(ThreadLocal&lt;?&gt; firstKey, Object firstValue) &#123;</span><br><span class="line">      table = new Entry[INITIAL_CAPACITY];</span><br><span class="line">      int i = firstKey.threadLocalHashCode &amp; (INITIAL_CAPACITY - 1);</span><br><span class="line">      table[i] = new Entry(firstKey, firstValue);</span><br><span class="line">      size = 1;</span><br><span class="line">      setThreshold(INITIAL_CAPACITY);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>我们惊奇的发现，ThreadLocalMap就是用ThreadLocal作为key的去设计的。<br>那么我们就可以串联起来，ThreadLocal的实现的大致流程是：</p>
<ul>
<li>在一个线程里面维护一个ThreadLocalMap</li>
<li>ThreadLocalMap里面可以有多个ThreadLocal，每个ThradLocal作为Key进行存储，将ThreadLocal的变量副本作为value进行保存。</li>
</ul>
<p><strong>所以刚才说，我们最简单的实现方式是：每个ThreadLocal用一个Map<threadid,vaule>的存储方式，Java的实现刚好相反，是通过线程里持有ThreadLocalMap<threadlocal,vaule>的方式，然后通过Thread找到对应的ThreadLocalMap的方式去实现的</threadlocal,vaule></threadid,vaule></strong></p>
</li>
</ul>
<h4 id="四、写在最后的总结"><a href="#四、写在最后的总结" class="headerlink" title="四、写在最后的总结"></a>四、写在最后的总结</h4><ul>
<li>每个线程是可以拥有多个ThreadLocal的，每个ThreadLocal跟ThreadLocal的值存在线程的ThreadLocalMap里面（这也是为什么要用ThreadLocal作为Key的原因）</li>
<li><p>在调用get方法的时候，需要先set，不然会报空指针异常，不然需要自己重写ThreadLocal的initialValue()方法，如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ThreadLocal&lt;Object&gt; threadLocal = new ThreadLocal&lt;Object&gt;()&#123;</span><br><span class="line">       @Override</span><br><span class="line">       protected Object initialValue() &#123;</span><br><span class="line">           return new Object();</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li>ThreadLocal存在的意义不是说为了解决多线程情况下，共享变量的同步问题，而更准确的说是为了解决当变量之间不相互依赖，在一个线程情况下不同的方法进行调用的问题。好比如我们的银行卡账户在不同的ATM机都可以取钱这样的case。我们有一个ThredLocalMap放着我们多个银行账户的副本，然后我们取什么银行的钱，往什么银行存钱都不会互相影响了，逃~~~ </li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/12/10/Java内存区域/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="不正">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/10/Java内存区域/" itemprop="url">Java虚拟机内存区域的那点事</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-12-10T23:36:04+08:00">
                2017-12-10
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="一、Java运行时数据区的组成"><a href="#一、Java运行时数据区的组成" class="headerlink" title="一、Java运行时数据区的组成"></a>一、Java运行时数据区的组成</h4><p>  Java的运行时数据区分为两个区域，一个是线程私有的区域，一个是线程共享的区域。</p>
<ul>
<li>线程私有<ul>
<li>Java虚拟机栈</li>
<li>本地方法栈</li>
<li>程序计数器</li>
</ul>
</li>
<li>线程共享<ul>
<li>堆</li>
<li>方法区</li>
</ul>
</li>
</ul>
<p><img src="https://user-gold-cdn.xitu.io/2017/12/6/1602c0738220d0cd?w=1254&amp;h=832&amp;f=png&amp;s=59099" alt="Java虚拟机运行时数据区"></p>
<h4 id="二、Java运行时数据区分析"><a href="#二、Java运行时数据区分析" class="headerlink" title="二、Java运行时数据区分析"></a>二、Java运行时数据区分析</h4><p> 从上面已经知道了，Java虚拟机运行时数据区按照线程私有与否可以进行划分，线程私有的会随着线程的创建以及销毁，因此这是不需要进行垃圾回收的区域。而线程共享的会进行垃圾回收。</p>
<ul>
<li><p>程序计数器</p>
<p> 在Java中，假如单核CPU，同时有多条线程跑的情况下，线程之间可能在让出CPU执行权的时候，某条线程的还没执行完被切出去了，那么需要有一个记录此时线程执行的属性的，而完成这一使命的就是程序计数器。</p>
<p> 程序计数器用于记录线程执行的字节码的行数，线程的分支跳转、循环、条件控制都基于程序计数器而完成的。</p>
<p> 如果线程执行的是Java方法，程序计数器记录的是执行的字节码的指令地址。而如果执行的是Native方法，则这个计数器为空。</p>
</li>
<li><p>Java虚拟机栈</p>
<p>Java虚拟机栈是线程私有的，每个线程都有一个栈，线程执行方法的过程对应的是栈帧的进栈以及出栈的过程。所以可以知道，栈帧实际上记录的就是方法的信息，比如局部变量表，动态链接，方法出口等信息。局部变量表存放的是基本数据类型以及对象引用。</p>
<p>如果请求栈的深度超过允许的栈深度，则会抛出StackOverFlowError的异常。</p>
</li>
<li><p>本地方法栈</p>
<p> 本地方法栈跟虚拟机栈是对应的，如果执行的不是Java的方法，那么就是在本地方法栈进行操作，同样会抛出StackOverFlowError的异常。</p>
</li>
<li><p>Java堆</p>
<p>   Java堆是在虚拟机启动的时候创建并划分大小的，Java堆的大小是可以通过参数进行控制的，设置Xmx跟Xms参数，空闲程度大于70%就调整到小的，小于40%就调整到大的，因为如此设置的话课比较频繁，所以很多case下都是设置为一样大小。</p>
<p>Java堆主要存放的是对象以及数组。</p>
</li>
<li><p>方法区</p>
<p>方法区同样是线程共享的，分为两部分。方法区主要存放的是类信息，而里面还有一个运行时常量池，用于存放编译产生的字面量以及符号引用。</p>
</li>
</ul>
<h4 id="三、如何创建对象"><a href="#三、如何创建对象" class="headerlink" title="三、如何创建对象"></a>三、如何创建对象</h4><p>Java作为一门面向对象语言，每时每刻都在产生对象。在语言层面，用到的是一个new关键字，但是在背后存在着复杂的逻辑。</p>
<ul>
<li><p>Java虚拟机遇到一个new操作的时候，会先去常量池里面查看能否定位到一个符号引用，并检查该符号引用对应的类是否被加载、解析以及初始化过，如果没有则执行类加载的过程。</p>
</li>
<li><p>创建对象的方式<br>在不同的虚拟机上有不同创建对象的方式，主要有以下两种。</p>
<ul>
<li><p>指针碰撞</p>
<p>  假设在内存都是规整的前提下，内存分为两块，一块是已经使用的区域，一块是待分配的区域。指针位于两个区域的中间，当需要分配内存的时候，计算需要分配的对象的大小，然后进行划分一个区域空间进行分配即可。</p>
</li>
<li><p>内存记录</p>
<p>但是实际情况总是不是那么美好的，内存不可能一直都是工整的，在这个时候就需要有一个列表，记录着内存中哪一块是空闲的区域，当需要分配的时候，在内存列表上进行查找，分配一个足够大的内存进行分配。</p>
</li>
</ul>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/12/10/JavaMemoryManager/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="不正">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/10/JavaMemoryManager/" itemprop="url">Java内存管理</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-12-10T23:35:03+08:00">
                2017-12-10
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="一、简述"><a href="#一、简述" class="headerlink" title="一、简述"></a>一、简述</h4><p>  Java的内存管理实际上解决了两个问题</p>
<ul>
<li>内存分配</li>
<li><p>内存回收</p>
<p>接下来分两部分学习Java的内存分配以及回收策略</p>
</li>
</ul>
<h4 id="二、Java垃圾收集"><a href="#二、Java垃圾收集" class="headerlink" title="二、Java垃圾收集"></a>二、Java垃圾收集</h4><h5 id="1、垃圾收集需要解决的问题"><a href="#1、垃圾收集需要解决的问题" class="headerlink" title="1、垃圾收集需要解决的问题"></a>1、垃圾收集需要解决的问题</h5><p>   在使用Java的时候，Java为我们提供了垃圾回收，使我们不需要去手动去进行对象的释放。但是垃圾回收是一门大学问，主要有以下三个问题：</p>
<ul>
<li>回收什么</li>
<li>怎么回收</li>
<li>几时回收</li>
</ul>
<h5 id="2、对象是否已经可以回收"><a href="#2、对象是否已经可以回收" class="headerlink" title="2、对象是否已经可以回收"></a>2、对象是否已经可以回收</h5><p>   在进行垃圾回收的时候，首先需要考虑的是我们的对象哪些可以进行回收，哪些不能进行回收。</p>
<ul>
<li><p>引用计数</p>
<p>在大多数的情况下，引用计数是有效果的，它也非常的简单，当对象上面有引用的时候，每增加一个引用，就增加对象上存在引用的个数，当对象减少引用的时候，就进行减一的操作，当计数为0的时候，说明该对象没有被其他对象引用到，可以进行回收。但是该方法存在的问题是，无法解决循环引用的问题。以下面的代码为例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"> /**</span><br><span class="line"> * Created by buzheng on 17/12/6.</span><br><span class="line"> * 测试循环引用</span><br><span class="line"> */</span><br><span class="line">public class MemoryTest &#123;</span><br><span class="line"></span><br><span class="line">    public Object instance = null;</span><br><span class="line"></span><br><span class="line">    public static void testGCRoot() &#123;</span><br><span class="line">        MemoryTest memoryTest1 = new MemoryTest();</span><br><span class="line">        MemoryTest memoryTest2 = new MemoryTest();</span><br><span class="line">        memoryTest1.instance = memoryTest2;</span><br><span class="line">        memoryTest2.instance = memoryTest1;</span><br><span class="line">        memoryTest1 = null;</span><br><span class="line">        memoryTest2 = null;</span><br><span class="line">       </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此时两个对象彼此之间相互持有，但是实际上它们已经没用了，引用计数法无法解决该类问题。</p>
<ul>
<li>可达性分析</li>
</ul>
<p>可达性分析解决了引用计数的弊端，它的思路是用GCRoot作为根节点，如果某个对象是有用的，那么总能找到属于它跟GCRoot的链路，如果某个对象，无法找到抵达GCRoot的路径，那么说明该对象是不可达的，可以进行回收操作。</p>
<p>如下图所示:<img src="https://s10.mogucdn.com//mlcdn/c45406/171206_8bc1bc9397f99c9i86914hag0i9f3_1528x942.png" alt="可达性分析（图来自深入理解Java虚拟机）"></p>
<p>从上图可以看到，object5等是没有链路到达GCRoot的，说明对象是不可达的，即使它存在引用，也是可以进行垃圾回收的。</p>
</li>
</ul>
<h5 id="3、使用什么算法进行回收"><a href="#3、使用什么算法进行回收" class="headerlink" title="3、使用什么算法进行回收"></a>3、使用什么算法进行回收</h5><ul>
<li><p>标记清除算法</p>
<p>标记清除算法是一种简单直接的清除算法，假设内存分为N块，在N块中如果分散着M块的区域是可以进行回收的，那么对着M块进行标记后回收。存在的问题主要是，因为内存是分散的，如果仅仅进行简单的标记清除的话，会造成内存碎片，也就是无法形成一整片的内存空间，假设有一个对象需要分配，而无法找到足够大的内存空间进行分配的时候，又会触发GC操作，所以JVM采用的都是基于标记清除算法改进的算法。</p>
</li>
</ul>
<ul>
<li><p>标记整理算法</p>
<p>标记整理算法指的是当在内存中，将存活的对象进行标记并整理到一块指定的内存中，然后对需要回收的对象进行回收。</p>
</li>
<li><p>复制算法</p>
<p>每次只用一半的内存进行使用，当需要回收的时候，将存活的对象移动到另外一半未使用的内存中，然后将需要回收的内存进行回收。</p>
<p>明显的是不同的算法适用于Java的不同对象分配的区域，在Java中，对象分配到两个区域，一个是新生代，一个是老年代，因为新生代是来得快去得快，所以比较适合复制算法，当然复制回收不是按照1：1的比例进行设置。而老年代是经过多次GC还存活下来的对象，说明是比较稳定的，可以采用标记整理算法。</p>
</li>
</ul>
<h4 id="三、对象的内存分配"><a href="#三、对象的内存分配" class="headerlink" title="三、对象的内存分配"></a>三、对象的内存分配</h4><p>  前面已经讲了对象何时进行回收以及使用什么方式进行回收，那么接下来讲的是对象如何进行内存的分配，我们的对象总得有个可以住的地方才行。</p>
<p>  Java对象分配的分配主要如下图：<br>  <img src="https://s10.mogucdn.com//mlcdn/c45406/171206_00b0j866ekie6l7d50987f0529adl_1014x456.png" alt="Java内存分配"></p>
<p>  从上图可以看到，内存分配主要分为新生代跟老年代。</p>
<ul>
<li><p>新生代</p>
<ul>
<li>Eden区</li>
<li>Survior区（又分为From跟To两个区域）</li>
</ul>
</li>
<li><p>老年代（经过多次GC的对象以及数组）</p>
</li>
</ul>
<p>对象分配的原则主要有以下几个：</p>
<ul>
<li><p>对象优先在Eden区域进行分配：当有对象需要分配的时候，大多数情况下会在Eden区进行分配，当Eden区域不够空间分配的时候，会触发MinorGC，假如做这样的假设：我们设置Xmx，Xms跟Xmn分别是20，20 ，10 ，说明我们的堆大小刚好是20，然后新生代大小为10，老年代的大小也为10，其中新生代的大小设置为8：1，我们按顺序new4个对象，分别是2，2，2，4，那么当分配到第四个的时候，发现Eden区已经不足以放下4M大小的对象，那么会进行MiniorGC,就会把前面3个往老年代放，然后把4放在Eden区。</p>
</li>
<li><p>大对象直接进入老年代：所谓大对象指的是需要连续分配的内存空间大的对象称之为大对象，假如对象大于我们设定的大对象的阈值，那么对象会直接被分配到老年代去。</p>
</li>
<li><p>长期存活的对象进入老年代：对象如果经历的MiniorGC大于我们设定的阈值，那么对象会被直接分配给老年代。</p>
</li>
</ul>
<h4 id="四、记录一次FullGC频繁的事情"><a href="#四、记录一次FullGC频繁的事情" class="headerlink" title="四、记录一次FullGC频繁的事情"></a>四、记录一次FullGC频繁的事情</h4><p>前阵子部门使用了新的框架，发布之后随着时间的增长发现机器经常出现FullGC的现象。经过前面的例子已经知道了FullGC是在老年代的进行的GC操作。<br>反向推导：最终同事发现是缓存的key有问题，请求参数我们使用请求的queryTime跟一些其他的业务key作为缓存的key，本意是如果用户在几分钟之内做同样的请求的话可以帮服务器分担一些压力，降低RT。后来发现每次的queryTime都是不一样的，导致缓存的key是没有用的，每次都是取出新的数据并再次加入缓存，而且缓存的时间过长，冗余了非常多的无效的数据在内存中，导致了内存吃紧而引发FullGC。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/12/10/JavaMemoryModel/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="不正">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/10/JavaMemoryModel/" itemprop="url">Java内存模型</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-12-10T00:02:20+08:00">
                2017-12-10
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h5 id="一、概念"><a href="#一、概念" class="headerlink" title="一、概念"></a>一、概念</h5><p>  Java内存模型（Java Memory Model）的可见性描述的是Java程序中线程共享的变量的访问规则，以及在JVM中将变量存储到内存以及从内存中读取变量的底层细节。</p>
<h5 id="二、Java共享变量的可见性"><a href="#二、Java共享变量的可见性" class="headerlink" title="二、Java共享变量的可见性"></a>二、Java共享变量的可见性</h5><p>  Java中的共享变量需要被<strong>其他线程</strong>访问的时候，该变量会拷贝一份<strong>变量副本</strong>到访问该线程的<strong>工作内存</strong>中，如下图所示：<br>  <img src="http://upload-images.jianshu.io/upload_images/1428117-c8e6162921dcc842.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Java多线程变量访问规则"><br>  从上图我们可以看到以下两点:</p>
<p>  1、线程对于共享变量的操作规定只能在该线程的工作内存中进行，而不能直接从主内存中进行读写操作.</p>
<p>  2、 不同线程之间彼此的工作内存中的变量是不能直接被访问的，每个线程对自己的工作内存负责，而线程之间变量值的传递需要通过<strong>主内存</strong>这个中心枢纽来完成。</p>
<h5 id="三、共享变量可见性的原理实现"><a href="#三、共享变量可见性的原理实现" class="headerlink" title="三、共享变量可见性的原理实现"></a>三、共享变量可见性的原理实现</h5><p> 假如我们有这样的case，变量x在线程1进行了修改，而线程2也需要进行及时看到变量x的变化情况，那么需要以下的步骤：<br>   1、线程1中的工作内存中更新的共享变量刷新到主内存中。<br> 2、 将主内存中最新的共享变量刷新到线程2的工作内存中。</p>
<ul>
<li><p>如何保证共享变量的可见性</p>
<ul>
<li>线程修改后的共享变量能及时从自己的工作内存中刷新到主内存中。</li>
<li>其他线程能及时的将共享变量的最新值从主内存中更新到自己的工作内存中。</li>
</ul>
</li>
<li><p>可见性的实现方式</p>
<ul>
<li><p>synchronized实现可见性</p>
<p>我们一直知道synchronized是加锁的操作，但是实际上，JMM对synchronized的规定是：线程解锁之前，必须把共享变量的最新值刷新到主内存中，并把线程的变量标注为失效。而线程加锁的时候，将工作内存中的标记为失效的共享变量的值从主内存重新读取最新的值。</p>
</li>
<li><p>volatile</p>
<ul>
<li>可见性<br>volatile实现内存的可见性是通过加入内存屏障以及进制重排序的优化进行实现的。对volatile变量进行写操作的时候，会在写操作后面加入一条<strong>store</strong>指令，该指令强制变量写操作之后一定要从工作内存中刷新到主内存中。而当volatile变量进行读操作的时候，会在读操作的前面加入<strong>load</strong>指令，该指令强制变量读操作之前一定要从主内存中更新变量的值。<ul>
<li>原子性：volatile不能保证volatile变量复合操作的原子性，举个简单的例子，如下面的例子:</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">private volatile int age = 10;</span><br><span class="line">age ++;</span><br></pre></td></tr></table></figure>
<p>其中，age++是需要经过三个过程的，第一个是从内存中读取age的值，第二是将age的值加1，第三是将age最新的值写入内存中。在这三个过程中，多线程情况下依旧可能会在执行第一步或者第二步的时候让出CPU的执行权，而导致变量被其他的线程所操作，发生不安全的问题。所以如果是需要保证原子性的时候，需要加入synchronized关键字。<br>简单代码如下:</p>
</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"> /**</span><br><span class="line"> * Created by buzheng on 17/12/3.</span><br><span class="line"> */</span><br><span class="line">public class TestVolatile &#123;</span><br><span class="line"></span><br><span class="line">    private volatile int age = 0;</span><br><span class="line"></span><br><span class="line">    public int getAge() &#123;</span><br><span class="line">        return age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void increaseAge() &#123;</span><br><span class="line">        age++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        final TestVolatile testVolatile = new TestVolatile();</span><br><span class="line">        for (int i = 0; i &lt; 100; i++)&#123;</span><br><span class="line">            new Thread(new Runnable() &#123;</span><br><span class="line">                @Override</span><br><span class="line">                public void run() &#123;</span><br><span class="line">                    testVolatile.increaseAge();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;).start();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        //如果超过2个线程在运行，让出CPU资源直到所有的子线程执行完</span><br><span class="line">        while (Thread.activeCount() &gt; 2)&#123;</span><br><span class="line">            Thread.yield();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.out.print(&quot;the result is &quot;+ testVolatile.getAge());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>   我们可以看到，如果运行这段代码是有可能出现result&lt;1000的，原因就是上面说的volatile对于对于变量的非原子操作同样是不安全的。解决volatile变量非原子操作不安全的问题，主要有以下方式:</p>
<p>   第一：加synchronized</p>
<p>   因为前面说了，synchronized关键字是可以保证可见性以及原子性的，既然volatile是可以保证可见性的，那么我们只需要通过synchronized保证操作的原子性即可。</p>
<p>   第二：lock<br>   lock也是跟synchronized异曲同工，也是加锁，注意应该释放锁的操作。代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Created by buzheng on 17/12/3.</span><br><span class="line"> */</span><br><span class="line">public class TestVolatile &#123;</span><br><span class="line"></span><br><span class="line">    private volatile int age = 0;</span><br><span class="line"></span><br><span class="line">    Lock lock = new ReentrantLock();</span><br><span class="line"></span><br><span class="line">    public int getAge() &#123;</span><br><span class="line">        return age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void increaseAge() &#123;</span><br><span class="line">        //第一个方式，加锁，可以保证age变量操作的原子性</span><br><span class="line">//        synchronized (this)&#123;</span><br><span class="line">//            age++;</span><br><span class="line">//        &#125;</span><br><span class="line">        //第二个方式</span><br><span class="line">        try &#123;</span><br><span class="line">            lock.lock();</span><br><span class="line">            age++;</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            lock.unlock();//释放锁</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        final TestVolatile testVolatile = new TestVolatile();</span><br><span class="line">        for (int i = 0; i &lt; 100; i++) &#123;</span><br><span class="line">            new Thread(new Runnable() &#123;</span><br><span class="line">                @Override</span><br><span class="line">                public void run() &#123;</span><br><span class="line">                    testVolatile.increaseAge();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;).start();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        //如果超过1个线程在运行，让出CPU资源直到所有的子线程执行完</span><br><span class="line">        while (Thread.activeCount() &gt; 2) &#123;</span><br><span class="line">            Thread.yield();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.out.print(&quot;the result is &quot; + testVolatile.getAge());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="四、synchronized与volatile比较"><a href="#四、synchronized与volatile比较" class="headerlink" title="四、synchronized与volatile比较"></a>四、synchronized与volatile比较</h5><ul>
<li>volatile不需要加锁 ，更加轻量级，不会阻塞线程。但只能保证可见性，不能保证原子性。</li>
<li>synchronized是通过加锁的方式进行保证可见性以及原子性的，所以会阻塞线程。但是使用场景更加广泛。  </li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/12/09/Python免密码登陆服务器/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="不正">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/09/Python免密码登陆服务器/" itemprop="url">Python实现ssh免密码登录+自定义命令操作服务器</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-12-09T13:57:38+08:00">
                2017-12-09
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="如何实现免密码登录服务器"><a href="#如何实现免密码登录服务器" class="headerlink" title="如何实现免密码登录服务器"></a>如何实现免密码登录服务器</h4><p><a href="https://github.com/buzheng1949/Athena/tree/master/FreeServer" target="_blank" rel="noopener">源代码</a><br>如果打不开请直接访问<strong><a href="https://github.com/buzheng1949/Athena/tree/master/FreeServer" target="_blank" rel="noopener">https://github.com/buzheng1949/Athena/tree/master/FreeServer</a></strong></p>
<p>首先介绍脚本背景，我司查看服务器的时候，需要经过<strong>登录堡垒机，输入查看的服务器的IP地址，输入命令对服务器进行操作的流程</strong>，为此学习了Python之后，鼓捣了一个Python版本的免密码登录服务器的脚本</p>
<h4 id="一、需求分析"><a href="#一、需求分析" class="headerlink" title="一、需求分析"></a>一、需求分析</h4><ul>
<li>登录堡垒机</li>
<li>登录服务器</li>
<li>输入命令</li>
</ul>
<h4 id="二、方案选择"><a href="#二、方案选择" class="headerlink" title="二、方案选择"></a>二、方案选择</h4><p>首先我们考虑的是Linux下是可以用expect进行ssh交互的，强大如Python当然也有这个能力，于是我们就自然想到了Python的pexpect库。<br>如果对pexpect库不熟悉的可以看下面的文章进行学习：<a href="http://www.jianshu.com/p/cfd163200d12" target="_blank" rel="noopener">pexpect学习教程</a></p>
<h4 id="三、方案实现"><a href="#三、方案实现" class="headerlink" title="三、方案实现"></a>三、方案实现</h4><ul>
<li>第一步，使用pexpect跟堡垒机打声招呼,以我司的登录堡垒机的命令为例子，<strong>ssh -pxxx username@server_ip</strong>，我们首先向服务器打声招呼。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">child = pexpect.spawn(&apos;ssh -pxxxxx %s@%s&apos;%(user_name,fortresses_ip))</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>得到服务器的回应后，对我进行了密码输入的请求，如下图：<br><img src="https://user-gold-cdn.xitu.io/2017/11/29/160087aca701041f?w=1134&amp;h=246&amp;f=png&amp;s=41990" alt="输入密码图片"></p>
<ul>
<li>第二步，okay，既然期待的是我输入密码，那么使用pexpect的另外一个大招，匹配返回的操作句柄，并进行密码发送。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ret_login = child.expect([&apos;%s@%s\&apos;s password:&apos;%(user_name,fortresses_ip),pexpect.TIMEOUT])</span><br><span class="line">child.sendline(password)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>从上面的两行代码我们可以看到，第一行代码使用了pexpect的expect方法，表示上一步返回的内容中是否包含expect里面的列表的关键字。第二行代码表示包含到了我们设想的关键字之后，我们可以模拟发送密码给远端。</p>
<ul>
<li>第三步，发送完密码之后，我们已经实现了登录堡垒机的功能，如下图所示:<br><img src="https://user-gold-cdn.xitu.io/2017/11/29/160087aca74a656f?w=1122&amp;h=384&amp;f=png&amp;s=37024" alt="登录堡垒机"><br>接下来就是输入我们需要登录的服务器的IP地址，然后再次输入密码，只需要调用两次pexpect的sendline方法即可完成服务器的交互。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ret_watch_server = child.expect([watch_server_ip,pexpect.TIMEOUT])</span><br><span class="line">            if ret_watch_server != 0:</span><br><span class="line">                print (&apos;the password is correct,but the server ip maybe you have no perssion,please apply it&apos;)</span><br><span class="line">                return</span><br><span class="line">            else:</span><br><span class="line">                child.sendline(watch_server_ip)</span><br><span class="line">                child.expect(&apos;password&apos;)</span><br><span class="line">                child.sendline(password)</span><br></pre></td></tr></table></figure>
<ul>
<li><p>第四步，但是即使进行免密码登录之后，我们还是很困扰，因为我们有两个问题还没解决，第一个问题是如何当我们想要登录查看的机器很多的时候，难道我每次都去改脚本的服务器的IP地址么？第二个问题是，难道我每次都需要去执行python xxx.py的方式去执行我们的脚本么？</p>
<ul>
<li>第一个问题的解决方式：我们可以使用docopt库进行在命令行执行Python命令的同时带上你想登录的服务器的IP地址。如下所示：<br><img src="https://user-gold-cdn.xitu.io/2017/11/29/160087aca83148d7?w=1642&amp;h=592&amp;f=png&amp;s=175542" alt="server"><br>这样我们就可以在执行Python命令的时候，按照usage的方式输入然后解析watch_server_ip字段的方式进行自定义查看服务器而无需改脚本的方式。如下图所示，在入口进行简单的判断：<br><img src="https://user-gold-cdn.xitu.io/2017/11/29/160087acac4f4fee?w=988&amp;h=150&amp;f=png&amp;s=32438" alt="server4"></li>
<li><p>第二个问题的解决方式：我们可以使用setuptools搞事情，代码如下所示：<br><img src="https://user-gold-cdn.xitu.io/2017/11/29/160087acabd7e208?w=1350&amp;h=542&amp;f=png&amp;s=69030" alt="setup"><br>从上面我们可以看到，我们定义了一个脚本，自定义了一个命令叫<strong>freeserver</strong>，然后调用freeserver脚本的时候，调用脚本的main方法。<br>编写完以上代码之后，我们执行<strong>python3 setup.py install</strong> 方法，就可以完成自定义命令行的方式输入而无需执行Python xxx.py xxxx_ip的麻烦的方式了。</p>
</li>
<li><p>第五步，让我们来看看效果吧,虽然都打了马赛克，但是红红绿绿的可以看到我们的脚本确实成功了。<br><img src="https://user-gold-cdn.xitu.io/2017/11/29/160087aca4fb03e1?w=1376&amp;h=962&amp;f=png&amp;s=99007" alt="success"></p>
</li>
</ul>
</li>
</ul>
<h4 id="果不其然的源代码分享"><a href="#果不其然的源代码分享" class="headerlink" title="果不其然的源代码分享"></a>果不其然的源代码分享</h4><ul>
<li>freeserver.py代码</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">&quot;&quot;&quot;免密码登录远端服务器</span><br><span class="line">Usage:</span><br><span class="line">    freeserver &lt;watch_server_ip&gt;</span><br><span class="line"></span><br><span class="line">Examples:</span><br><span class="line">    freeserver xxxxxxx</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line">import pexpect</span><br><span class="line">import os </span><br><span class="line">import getpass</span><br><span class="line">from docopt import docopt</span><br><span class="line"># 实现免密码登录方法</span><br><span class="line">def login(fortresses_ip,user_name,password,watch_server_ip,command):</span><br><span class="line">    child = pexpect.spawn(&apos;ssh -pxxx %s@%s&apos;%(user_name,fortresses_ip))</span><br><span class="line">    ret_login = child.expect([&apos;%s@%s\&apos;s password:&apos;%(user_name,fortresses_ip),pexpect.TIMEOUT])</span><br><span class="line">    if ret_login == 1:</span><br><span class="line">        print (&apos;login the remote server ip is timeout&apos;)</span><br><span class="line">        return</span><br><span class="line">    else:</span><br><span class="line">        child.sendline(password)</span><br><span class="line">        ret_password = child.expect([&apos;This is a beta version. If you find bugs, please contact @Securit&apos;,pexpect.TIMEOUT])</span><br><span class="line">        if ret_password == 1:</span><br><span class="line">            print (&apos;the password is wrong,please check the password&apos;)</span><br><span class="line">            return</span><br><span class="line">        else:</span><br><span class="line">            child.sendline(&apos;p&apos;)</span><br><span class="line">            ret_watch_server = child.expect([watch_server_ip,pexpect.TIMEOUT])</span><br><span class="line">            if ret_watch_server != 0:</span><br><span class="line">                print (&apos;the password is correct,but the server ip maybe you have no perssion,please apply it&apos;)</span><br><span class="line">                return</span><br><span class="line">            else:</span><br><span class="line">                child.sendline(watch_server_ip)</span><br><span class="line">                child.expect(&apos;password&apos;)</span><br><span class="line">                child.sendline(password)</span><br><span class="line">                child.expect(&apos;Powered&apos;)</span><br><span class="line">                if command is not None:</span><br><span class="line">                    child.sendline(command)</span><br><span class="line">                child.sendline(&apos;tailf web.log&apos;)</span><br><span class="line">                child.interact()</span><br><span class="line"></span><br><span class="line">def main():</span><br><span class="line">    arguments = docopt(__doc__)</span><br><span class="line">    watch_server_ip = arguments.get(&apos;&lt;watch_server_ip&gt;&apos;)</span><br><span class="line">    user_name = &apos;your user name&apos;</span><br><span class="line">    password = &apos;your password&apos;</span><br><span class="line">    fortresses_ip = &apos;fortresses_ip&apos;</span><br><span class="line">    command = &apos;your command when your want success enter the ip server&apos;</span><br><span class="line">    login(fortresses_ip,user_name,password,watch_server_ip,command)</span><br><span class="line"></span><br><span class="line">if __name__ == &apos;__main__&apos;:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<ul>
<li>setup.py</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">from setuptools import setup </span><br><span class="line">setup( </span><br><span class="line">    name=&apos;freeserver&apos;,</span><br><span class="line">    py_modules=[&apos;__inti__&apos;, &apos;freeserver&apos;], </span><br><span class="line">    install_requires=[&apos;pexpect&apos;], </span><br><span class="line">    entry_points=&#123; </span><br><span class="line">        &apos;console_scripts&apos;: [&apos;freeserver=freeserver:main&apos;] </span><br><span class="line">        &#125; </span><br><span class="line">    )</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">不正</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">9</span>
                  <span class="site-state-item-name">Artikel</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">2</span>
                  <span class="site-state-item-name">Tags</span>
                
              </div>
            

          </nav>

          

          <div class="links-of-author motion-element">
            
              
                <span class="links-of-author-item">
                  <a href="https://github.com/buzheng1949" target="_blank" title="GitHub">
                    
                      <i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  <a href="mailto:yupeibiao@gmail.com" target="_blank" title="E-Mail">
                    
                      <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                </span>
              
            
          </div>

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">不正</span>

  
</div>


  <div class="powered-by">Erstellt mit  <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.3</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
